<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <title>Input Kegiatan RPPM - RA TAHFIDZI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #2e7d32;
      --primary-light: #4caf50;
      --primary-dark: #1b5e20;
      --background-color: #f5f9f5;
      --card-bg: #ffffff;
      --border-color: #c8e6c9;
      --error-color: #d32f2f;
      --success-color: #388e3c;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: #333;
    }
    
    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }
    
    .login-card {
      width: 100%;
      max-width: 400px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    .form-section {
      margin-bottom: 25px;
      padding: 20px;
      background-color: #f9fbf9;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }

    .kegiatan-card {
        background-color: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.25rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Custom Alert Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.8);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
    }

    .modal-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 20px;
    }

    .modal-icon.success { background-color: rgba(56, 142, 60, 0.1); color: var(--success-color); }
    .modal-icon.error { background-color: rgba(211, 47, 47, 0.1); color: var(--error-color); }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-body { padding: 20px; line-height: 1.5; }
    .modal-footer { padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; }
    .modal-button { padding: 8px 20px; border-radius: 50px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
    .modal-button.primary { background: linear-gradient(to right, var(--primary-color), var(--primary-light)); color: white; }
    .modal-button.secondary { background-color: #e0e0e0; color: #333; }

    /* Pagination Button Styles */
    .pagination-btn {
        @apply px-3 py-1 mx-1 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
    }
    .pagination-btn.active {
        @apply bg-blue-600 text-white border-blue-600 hover:bg-blue-700;
    }
    .pagination-btn:disabled {
        @apply bg-gray-100 text-gray-400 cursor-not-allowed;
    }
  </style>
</head>
<body class="font-sans">

  <!-- Login Page -->
  <div id="loginPage" class="container mx-auto mt-10">
    <div class="login-container">
      <div class="login-card">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-green-700">Input Kegiatan RPPM</h1>
          <p class="text-gray-600">Silakan login untuk melanjutkan</p>
        </div>
        <form id="loginForm" class="flex flex-col">
          <label for="teacherSelect" class="font-semibold mb-2">Pilih Guru</label>
          <select id="teacherSelect" required class="border rounded-lg p-2 mb-4">
            <option value="" disabled selected>-- Pilih Guru --</option>
          </select>
          <label for="password" class="font-semibold mb-2">Password</label>
          <input type="password" id="password" placeholder="Masukkan password" required class="border rounded-lg p-2">
          <div id="errorMessage" class="text-red-600 text-sm mt-2 hidden">Password salah.</div>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-6">Login</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <header class="bg-white shadow-md">
      <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-green-800">Input Kegiatan Mingguan</h1>
          <p class="text-gray-600" id="welcomeMessage">Selamat datang, -</p>
        </div>
        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
          <i class="fas fa-sign-out-alt mr-1"></i> Logout
        </button>
      </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
      <!-- TABEL DATA RPPM -->
<div id="rppmTableContainer" class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100 mb-6 hidden transition-all duration-300 hover:shadow-2xl">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
    <h2 class="text-2xl font-bold text-green-700 flex items-center gap-2">
      <i class="fas fa-calendar-alt text-green-600"></i>
      Daftar RPPM
    </h2>

    <div class="flex flex-row gap-3 flex-nowrap">
      <a href="input.html"
         class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-2.5 px-5 rounded-xl text-sm shadow-md flex items-center gap-2 transition-all duration-300 whitespace-nowrap">
        <i class="fas fa-plus-circle"></i>
        Tambah RPPM Baru
      </a>

      <a href="rekaprppm.html"
         class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-2.5 px-5 rounded-xl text-sm shadow-md flex items-center gap-2 transition-all duration-300 whitespace-nowrap">
        <i class="fas fa-pen-alt"></i>
        Edit & Cetak RPPM
      </a>
    </div>
  </div>
</div>


      <form id="kegiatanForm">
        <div class="bg-white p-6 rounded-lg shadow-lg">
          
          <!-- RPPM Selection -->
          <div class="form-section">
            <h2 class="text-xl font-semibold text-green-800 mb-4">Isi Kegiatan Harian RPPM</h2>
            <label for="rppmSelect" class="block text-sm font-medium text-gray-700">Pilih Tema/Subtema RPPM yang akan diisi kegiatannya:</label>
            <select id="rppmSelect" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
              <option value="" disabled selected>-- PILIH RPPM --</option>
            </select>
          </div>

          <!-- Kegiatan Harian -->
          <div id="kegiatanContainer" class="mt-6 hidden">
            <h2 class="text-xl font-semibold text-green-800 mb-4">Isi Kegiatan Harian</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              
              <!-- Card untuk setiap hari -->
              <div class="kegiatan-card">
                <h3 class="text-lg font-bold text-green-700 mb-3">Senin</h3>
                <label for="tanggal_senin" class="block text-sm font-medium text-gray-700">Tanggal</label>
                <input type="date" id="tanggal_senin" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                
                <label for="kegiatan_senin" class="block text-sm font-medium text-gray-700 mt-3">Kegiatan</label>
                <textarea id="kegiatan_senin" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Contoh:
1. Berbaris dan berdoa
2. Menggambar bebas
3. Istirahat"></textarea>
                
                <label for="alat_bahan_senin" class="block text-sm font-medium text-gray-700 mt-3">Alat dan Bahan</label>
                <textarea id="alat_bahan_senin" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Contoh:
- Kertas gambar
- Pensil warna"></textarea>
              </div>

              <div class="kegiatan-card">
                <h3 class="text-lg font-bold text-green-700 mb-3">Selasa</h3>
                <label for="tanggal_selasa" class="block text-sm font-medium text-gray-700">Tanggal</label>
                <input type="date" id="tanggal_selasa" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                <label for="kegiatan_selasa" class="block text-sm font-medium text-gray-700 mt-3">Kegiatan</label>
                <textarea id="kegiatan_selasa" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                <label for="alat_bahan_selasa" class="block text-sm font-medium text-gray-700 mt-3">Alat dan Bahan</label>
                <textarea id="alat_bahan_selasa" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
              </div>

              <div class="kegiatan-card">
                <h3 class="text-lg font-bold text-green-700 mb-3">Rabu</h3>
                <label for="tanggal_rabu" class="block text-sm font-medium text-gray-700">Tanggal</label>
                <input type="date" id="tanggal_rabu" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                <label for="kegiatan_rabu" class="block text-sm font-medium text-gray-700 mt-3">Kegiatan</label>
                <textarea id="kegiatan_rabu" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                <label for="alat_bahan_rabu" class="block text-sm font-medium text-gray-700 mt-3">Alat dan Bahan</label>
                <textarea id="alat_bahan_rabu" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
              </div>

              <div class="kegiatan-card">
                <h3 class="text-lg font-bold text-green-700 mb-3">Kamis</h3>
                <label for="tanggal_kamis" class="block text-sm font-medium text-gray-700">Tanggal</label>
                <input type="date" id="tanggal_kamis" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                <label for="kegiatan_kamis" class="block text-sm font-medium text-gray-700 mt-3">Kegiatan</label>
                <textarea id="kegiatan_kamis" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                <label for="alat_bahan_kamis" class="block text-sm font-medium text-gray-700 mt-3">Alat dan Bahan</label>
                <textarea id="alat_bahan_kamis" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
              </div>

              <div class="kegiatan-card">
                <h3 class="text-lg font-bold text-green-700 mb-3">Jum'at</h3>
                <label for="tanggal_jumat" class="block text-sm font-medium text-gray-700">Tanggal</label>
                <input type="date" id="tanggal_jumat" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                <label for="kegiatan_jumat" class="block text-sm font-medium text-gray-700 mt-3">Kegiatan</label>
                <textarea id="kegiatan_jumat" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                <label for="alat_bahan_jumat" class="block text-sm font-medium text-gray-700 mt-3">Alat dan Bahan</label>
                <textarea id="alat_bahan_jumat" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
              </div>

              <div class="kegiatan-card">
                <h3 class="text-lg font-bold text-green-700 mb-3">Sabtu</h3>
                <label for="tanggal_sabtu" class="block text-sm font-medium text-gray-700">Tanggal</label>
                <input type="date" id="tanggal_sabtu" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                <label for="kegiatan_sabtu" class="block text-sm font-medium text-gray-700 mt-3">Kegiatan</label>
                <textarea id="kegiatan_sabtu" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                <label for="alat_bahan_sabtu" class="block text-sm font-medium text-gray-700 mt-3">Alat dan Bahan</label>
                <textarea id="alat_bahan_sabtu" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
              </div>

            </div>

            <div class="mt-8 flex justify-end gap-4">
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Simpan Kegiatan</button>
            </div>
          </div>
        </div>
      </form>
      
<div class="bg-white rounded-2xl shadow-md p-4 sm:p-6 lg:p-8">
  <!-- Judul -->
  <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-2">
    <div class="text-center sm:text-left">
      <h2 class="text-2xl font-bold text-green-700">Edit Informasi Umum</h2>
      <p class="text-gray-500 text-sm mt-1">Data tema, subtema, dan refleksi</p>
    </div>
  </div>

  <!-- Wrapper tabel -->
  <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gradient-to-r from-green-100 to-green-200">
        <tr>
          <th class="px-6 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Tema</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Subtema</th>
          <th class="px-6 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Semester</th>
          <th class="px-6 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Aksi</th>
        </tr>
      </thead>
      <tbody id="rppmTableBody" class="divide-y divide-gray-100 bg-white">
        <!-- Contoh baris -->
        <tr>
          <td class="px-6 py-3 text-gray-700">Tema 1</td>
          <td class="px-6 py-3 text-gray-700">Subtema A</td>
          <td class="px-6 py-3 text-gray-700">Semester 1</td>
          <td class="px-6 py-3 text-center">
            <div class="flex justify-center gap-2">
              <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs font-semibold shadow-sm transition">
                Edit
              </button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-xs font-semibold shadow-sm transition">
                Hapus
              </button>
            </div>
          </td>
        </tr>
        <!-- Data dinamis diisi oleh JavaScript -->
      </tbody>
    </table>
  </div>
</div>
  <!-- Pagination -->
  <div id="paginationControls" class="flex flex-col sm:flex-row justify-between items-center gap-3 mt-6 text-sm">
    <span class="text-gray-600">Menampilkan <strong>1–10</strong> dari <strong>50</strong> data</span>
    <div class="flex space-x-2">
      <button class="px-3 py-1 border rounded-lg text-gray-600 hover:bg-gray-100 transition">&laquo;</button>
      <button class="px-3 py-1 border rounded-lg bg-green-500 text-white hover:bg-green-600 transition">1</button>
      <button class="px-3 py-1 border rounded-lg text-gray-600 hover:bg-gray-100 transition">2</button>
      <button class="px-3 py-1 border rounded-lg text-gray-600 hover:bg-gray-100 transition">&raquo;</button>
    </div>
  </div>
</div>


      </div>
      
    </main>
  </div>

  <!-- Custom Alert Modal -->
  <div class="modal-overlay" id="alertModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-icon" id="modalIcon"><span id="modalIconSymbol"></span></div>
        <div class="modal-title" id="modalTitle"></div>
      </div>
      <div class="modal-body" id="modalMessage"></div>
      <div class="modal-footer">
        <button class="modal-button primary" id="modalButton">OK</button>
      </div>
    </div>
  </div>

  <!-- Edit RPPM Modal -->
  <div class="modal-overlay" id="editRppmModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Data RPPM</h3>
        <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editRppmForm">
        <div class="modal-body grid grid-cols-1 gap-4">
            <input type="hidden" id="edit_rppm_id">
            <div>
                <label for="edit_kelas" class="block text-sm font-medium text-gray-700">Kelas</label>
                <input type="text" id="edit_kelas" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div>
                <label for="edit_tema" class="block text-sm font-medium text-gray-700">Tema</label>
                <input type="text" id="edit_tema" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div>
                <label for="edit_subtema" class="block text-sm font-medium text-gray-700">Subtema</label>
                <input type="text" id="edit_subtema" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div>
                <label for="edit_semester" class="block text-sm font-medium text-gray-700">Semester</label>
                <input type="text" id="edit_semester" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div>
                <label for="edit_tujuan_pembelajaran" class="block text-sm font-medium text-gray-700">Tujuan Pembelajaran</label>
                <textarea id="edit_tujuan_pembelajaran" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
            <div>
                <label for="edit_refleksi" class="block text-sm font-medium text-gray-700">Refleksi</label>
                <textarea id="edit_refleksi" rows="3" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-button secondary" onclick="closeEditModal()">Batal</button>
            <button type="submit" class="modal-button primary">Simpan Perubahan</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- SUPABASE INITIALIZATION ---
    const supabaseUrl = 'https://hjvppgbcltgiibdxqtka.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqdnBwZ2JjbHRnaWliZHhxdGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyNzUzNDgsImV4cCI6MjA0OTg1MTM0OH0.3X7KMHg3qMdsgYsulWxC-hGvpjkGt-9V_YTbd7PSeOw';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // --- GLOBAL STATE ---
    let loggedInUser = null;
    let allRppmData = []; // Menyimpan semua data RPPM untuk pagination
    const itemsPerPage = 5; // Jumlah item per halaman
    let currentPage = 1; // Halaman saat ini

    // --- DOM ELEMENTS ---
    const loginPage = document.getElementById('loginPage');
    const mainContent = document.getElementById('mainContent');

    // --- CUSTOM ALERT ---
    function showAlert(title, message, type = 'info') {
      const modal = document.getElementById('alertModal');
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      const icon = document.getElementById('modalIcon');
      const iconSymbol = document.getElementById('modalIconSymbol');
      icon.className = 'modal-icon ' + type;
      iconSymbol.textContent = type === 'success' ? '✓' : (type === 'error' ? '✕' : '!');
      modal.classList.add('show');
      document.getElementById('modalButton').onclick = () => modal.classList.remove('show');
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
      await populateTeacherDropdown();
      checkSession();
      initializeEventListeners();
    });

    function initializeEventListeners() {
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('kegiatanForm').addEventListener('submit', handleSaveKegiatan);
      document.getElementById('editRppmForm').addEventListener('submit', handleEditRppm);
      document.getElementById('paginationControls').addEventListener('click', handlePaginationClick);

      const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
      days.forEach(day => {
        document.getElementById(`tanggal_${day}`).addEventListener('change', autoFillDates);
      });
    }

    // --- AUTH & SESSION ---
    async function populateTeacherDropdown() {
      const teacherSelect = document.getElementById('teacherSelect');
      const { data, error } = await supabase.from('ra_guru').select('id, nama').order('nama');

      if (error) {
        console.error('Error fetching teachers:', error);
        return;
      }

      data.forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.nama;
        teacherSelect.appendChild(option);
      });
    }

    async function handleLogin(e) {
      e.preventDefault();
      const teacherId = document.getElementById('teacherSelect').value;
      const password = document.getElementById('password').value;
      const errorMessage = document.getElementById('errorMessage');

      const { data: teacher, error } = await supabase
        .from('ra_guru').select('*').eq('id', teacherId).eq('password', password).single();

      if (error || !teacher) {
        errorMessage.classList.remove('hidden');
        return;
      }

      errorMessage.classList.add('hidden');
      localStorage.setItem('loggedInUser', JSON.stringify(teacher));
      showMainApp(teacher);
    }

    function handleLogout() {
      localStorage.removeItem('loggedInUser');
      loggedInUser = null;
      loginPage.classList.remove('hidden');
      mainContent.classList.add('hidden');
      document.getElementById('loginForm').reset();
    }

    function checkSession() {
      const userJson = localStorage.getItem('loggedInUser');
      if (userJson) {
        const userData = JSON.parse(userJson);
        showMainApp(userData);
      }
    }

    function showMainApp(userData) {
      loggedInUser = userData;
      loginPage.classList.add('hidden');
      mainContent.classList.remove('hidden');
      document.getElementById('welcomeMessage').textContent = `Selamat datang, ${userData.nama}`;
      
      document.getElementById('rppmTableContainer').classList.remove('hidden');
      fetchAndDisplayRppmTableWithPagination(userData.id);
      
      populateRppmDropdown(userData.id);
    }

    // --- RPPM TABLE LOGIC WITH PAGINATION ---
    async function fetchAndDisplayRppmTableWithPagination(guruId) {
        const tableBody = document.getElementById('rppmTableBody');
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Memuat data...</td></tr>';

        const { data, error } = await supabase
            .from('ra_rppm')
            .select('*')
            .eq('guru_id', guruId)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error fetching RPPM table:', error);
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat data.</td></tr>';
            return;
        }

        allRppmData = data || [];
        currentPage = 1;
        displayRppmPage();
    }

    function displayRppmPage() {
        const tableBody = document.getElementById('rppmTableBody');
        const paginationControls = document.getElementById('paginationControls');
        
        const totalPages = Math.ceil(allRppmData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedData = allRppmData.slice(startIndex, endIndex);

        if (allRppmData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada data RPPM.</td></tr>';
            paginationControls.innerHTML = '';
            return;
        }

        tableBody.innerHTML = '';
        paginatedData.forEach(rppm => {
            const row = `
                <tr>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">${rppm.tema}</td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">${rppm.subtema}</td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">${rppm.semester}</td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm text-center">
                        <button onclick="openEditModal(${rppm.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deleteRppm(${rppm.id}, '${rppm.semester}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        renderPaginationControls(totalPages, paginatedData.length, startIndex);
    }

    function renderPaginationControls(totalPages, itemsOnPage, startIndex) {
        const paginationControls = document.getElementById('paginationControls');
        if (totalPages <= 1) {
            paginationControls.innerHTML = '';
            return;
        }

        let controlsHtml = `
            <div class="text-sm text-gray-700">
                Menampilkan ${startIndex + 1} hingga ${startIndex + itemsOnPage} dari ${allRppmData.length} data
            </div>
            <div class="flex gap-1">
        `;

        controlsHtml += `
            <button 
                class="pagination-btn" 
                onclick="goToPage(${currentPage - 1})" 
                ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        `;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                 controlsHtml += `
                    <button 
                        class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                        onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                controlsHtml += `<span class="px-2">...</span>`;
            }
        }

        controlsHtml += `
            <button 
                class="pagination-btn" 
                onclick="goToPage(${currentPage + 1})" 
                ${currentPage === totalPages ? 'disabled' : ''}>
                Next <i class="fas fa-chevron-right"></i>
            </button>
        `;

        controlsHtml += `</div>`;
        paginationControls.innerHTML = controlsHtml;
    }

    function goToPage(page) {
        const totalPages = Math.ceil(allRppmData.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            displayRppmPage();
        }
    }
    
    function handlePaginationClick(e) {
        // Fungsi ini tidak lagi digunakan karena onclick langsung di tombol
    }

    // --- RPPM EDIT & DELETE LOGIC ---
    async function openEditModal(rppmId) {
        const { data, error } = await supabase.from('ra_rppm').select('*').eq('id', rppmId).single();
        if (error) {
            showAlert('Gagal', 'Tidak dapat mengambil data RPPM.', 'error');
            return;
        }

        document.getElementById('edit_rppm_id').value = data.id;
        document.getElementById('edit_kelas').value = data.kelas;
        document.getElementById('edit_tema').value = data.tema;
        document.getElementById('edit_subtema').value = data.subtema;
        document.getElementById('edit_semester').value = data.semester;
        document.getElementById('edit_tujuan_pembelajaran').value = data.tujuan_pembelajaran;
        document.getElementById('edit_refleksi').value = data.refleksi;

        document.getElementById('editRppmModal').classList.add('show');
    }

    function closeEditModal() {
        document.getElementById('editRppmModal').classList.remove('show');
        document.getElementById('editRppmForm').reset();
    }

    async function handleEditRppm(e) {
        e.preventDefault();
        const rppmId = document.getElementById('edit_rppm_id').value;
        const updatedData = {
            kelas: document.getElementById('edit_kelas').value,
            tema: document.getElementById('edit_tema').value,
            subtema: document.getElementById('edit_subtema').value,
            semester: document.getElementById('edit_semester').value,
            tujuan_pembelajaran: document.getElementById('edit_tujuan_pembelajaran').value,
            refleksi: document.getElementById('edit_refleksi').value,
        };

        const { error } = await supabase
            .from('ra_rppm')
            .update(updatedData)
            .eq('id', rppmId);

        if (error) {
            showAlert('Gagal', `Gagal memperbarui data: ${error.message}`, 'error');
        } else {
            showAlert('Berhasil', 'Data RPPM berhasil diperbarui!', 'success');
            closeEditModal();
            fetchAndDisplayRppmTableWithPagination(loggedInUser.id);
            populateRppmDropdown(loggedInUser.id);
        }
    }

    async function deleteRppm(rppmId, rppmSemester) {
        if (!confirm(`Apakah Anda yakin ingin menghapus RPPM "${rppmSemester}"? Tindakan ini tidak dapat dibatalkan.`)) {
            return;
        }

        const { error } = await supabase.from('ra_rppm').delete().eq('id', rppmId);

        if (error) {
            showAlert('Gagal', `Gagal menghapus data: ${error.message}`, 'error');
        } else {
            showAlert('Berhasil', 'Data RPPM berhasil dihapus.', 'success');
            fetchAndDisplayRppmTableWithPagination(loggedInUser.id);
            populateRppmDropdown(loggedInUser.id);
        }
    }

    // --- APP LOGIC (Kegiatan Harian) ---
    async function populateRppmDropdown(guruId) {
      const rppmSelect = document.getElementById('rppmSelect');
      rppmSelect.innerHTML = '<option value="" disabled selected>-- Memuat RPPM... --</option>';

      const { data, error } = await supabase
        .from('ra_rppm')
        .select('id, semester, tema, subtema')
        .eq('guru_id', guruId)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching RPPMs:', error);
        rppmSelect.innerHTML = '<option value="" disabled selected>Gagal memuat data</option>';
        return;
      }

      rppmSelect.innerHTML = '<option value="" disabled selected>-- Pilih RPPM --</option>';
      if (data.length === 0) {
        rppmSelect.innerHTML = '<option value="" disabled selected>Belum ada RPPM dibuat</option>';
      }

      data.forEach(rppm => {
        const option = document.createElement('option');
        option.value = rppm.id;
        // Menampilkan informasi lengkap di dropdown
        option.textContent = `${rppm.semester} - ${rppm.tema} - ${rppm.subtema}`;
        rppmSelect.appendChild(option);
      });

      // Tambahkan event listener untuk memuat data kegiatan saat RPPM dipilih
      rppmSelect.addEventListener('change', async (e) => {
          const rppmId = e.target.value;
          const kegiatanContainer = document.getElementById('kegiatanContainer');
          
          // Reset form kegiatan
          const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
          days.forEach(day => {
              document.getElementById(`tanggal_${day}`).value = '';
              document.getElementById(`kegiatan_${day}`).value = '';
              document.getElementById(`alat_bahan_${day}`).value = '';
          });

          if (!rppmId) {
              kegiatanContainer.classList.add('hidden');
              return;
          }
          
          kegiatanContainer.classList.remove('hidden');
          
          // Ambil data kegiatan yang sudah ada
          const { data: kegiatanData, error } = await supabase
              .from('ra_kegiatan_harian')
              .select('*')
              .eq('rppm_id', rppmId);
          
          if (error) {
              console.error('Error fetching kegiatan:', error);
              return;
          }
          
          // Isi form dengan data yang sudah ada
          if (kegiatanData && kegiatanData.length > 0) {
              kegiatanData.forEach(kegiatan => {
                  const day = kegiatan.hari.toLowerCase();
                  const tanggalField = document.getElementById(`tanggal_${day}`);
                  const kegiatanField = document.getElementById(`kegiatan_${day}`);
                  const alatBahanField = document.getElementById(`alat_bahan_${day}`);
                  
                  if (tanggalField) tanggalField.value = kegiatan.tanggal || '';
                  if (kegiatanField) kegiatanField.value = kegiatan.kegiatan || '';
                  if (alatBahanField) alatBahanField.value = kegiatan.alat_bahan || '';
              });
          }
      });
    }

    function validateWeekDates() {
      const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
      const filledDates = {};
      
      days.forEach(day => {
        const dateValue = document.getElementById(`tanggal_${day}`).value;
        if (dateValue) {
          filledDates[day] = new Date(dateValue + 'T00:00:00.000Z');
        }
      });
      
      if (Object.keys(filledDates).length < 2) {
        return true;
      }
      
      const sortedDates = Object.values(filledDates).sort((a, b) => a - b);
      
      for (let i = 1; i < sortedDates.length; i++) {
        const diffTime = Math.abs(sortedDates[i] - sortedDates[i-1]);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays !== 1) {
          showAlert('Peringatan', 'Tanggal tidak berurutan. Pastikan semua tanggal membentuk minggu yang valid.', 'error');
          return false;
        }
      }
      
      return true;
    }

    async function handleSaveKegiatan(e) {
        e.preventDefault();
        const rppmId = document.getElementById('rppmSelect').value;

        if (!rppmId) {
            showAlert('Peringatan', 'Silakan pilih RPPM terlebih dahulu.', 'error');
            return;
        }

        if (!validateWeekDates()) {
            return;
        }

        const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
        const kegiatanData = [];

        for (const day of days) {
            const tanggal = document.getElementById(`tanggal_${day}`).value;
            const kegiatan = document.getElementById(`kegiatan_${day}`).value;
            const alat_bahan = document.getElementById(`alat_bahan_${day}`).value;

            if (tanggal || kegiatan || alat_bahan) {
                kegiatanData.push({
                    rppm_id: rppmId,
                    guru_id: loggedInUser.id, // Menyimpan ID guru yang sedang login
                    hari: day.charAt(0).toUpperCase() + day.slice(1),
                    tanggal: tanggal ? tanggal : null,
                    kegiatan: kegiatan,
                    alat_bahan: alat_bahan
                });
            }
        }

        if (kegiatanData.length === 0) {
            showAlert('Informasi', 'Tidak ada data kegiatan yang diisi untuk disimpan.', 'info');
            return;
        }

        // Loop melalui setiap item kegiatan untuk melakukan insert atau update manual
        for (const kegiatan of kegiatanData) {
            // Cek apakah data untuk hari ini sudah ada
            const { data: existing, error: selectError } = await supabase
                .from('ra_kegiatan_harian')
                .select('id')
                .eq('rppm_id', kegiatan.rppm_id)
                .eq('hari', kegiatan.hari)
                .single();

            // Handle error saat pengecekan, abaikan jika error karena data tidak ditemukan (PGRST116)
            if (selectError && selectError.code !== 'PGRST116') {
                console.error('Error checking existing data:', selectError);
                showAlert('Gagal', `Gagal memeriksa data: ${selectError.message}`, 'error');
                return; // Hentikan proses jika ada error database
            }

            let queryError = null;

            if (existing) {
                // Jika data ada, lakukan UPDATE
                const { error } = await supabase
                    .from('ra_kegiatan_harian')
                    .update(kegiatan)
                    .eq('id', existing.id);
                queryError = error;
            } else {
                // Jika data tidak ada, lakukan INSERT
                const { error } = await supabase
                    .from('ra_kegiatan_harian')
                    .insert(kegiatan);
                queryError = error;
            }

            if (queryError) {
                console.error('Error saving kegiatan:', queryError);
                showAlert('Gagal', `Gagal menyimpan data untuk hari ${kegiatan.hari}: ${queryError.message}`, 'error');
                return; // Hentikan jika ada error saat menyimpan
            }
        }

        showAlert('Berhasil', 'Data kegiatan mingguan berhasil disimpan!', 'success');
    }

    // --- TIMEZONE HELPER FUNCTIONS ---
    const WITA_TIMEZONE = 'Asia/Makassar';

    function formatDateForWitaInput(date) {
        return date.toLocaleDateString('en-CA', { timeZone: WITA_TIMEZONE });
    }

    function getDayInWita(date) {
        const dayName = date.toLocaleDateString('en-US', { timeZone: WITA_TIMEZONE, weekday: 'long' });
        const days = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
        return days[dayName];
    }

    function autoFillDates(e) {
        const changedDateValue = e.target.value;
        
        if (!changedDateValue) {
            return;
        }

        try {
            const changedDate = new Date(changedDateValue + 'T00:00:00.000Z');
            const dayOfWeekInWita = getDayInWita(changedDate);
            
            let offsetToMonday = dayOfWeekInWita - 1;
            if (dayOfWeekInWita === 0) {
                offsetToMonday = -6;
            }
            
            const mondayDate = new Date(changedDate);
            mondayDate.setDate(changedDate.getDate() - offsetToMonday);
            
            const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
            for (let i = 0; i < days.length; i++) {
                const currentDate = new Date(mondayDate);
                currentDate.setDate(mondayDate.getDate() + i);
                document.getElementById(`tanggal_${days[i]}`).value = formatDateForWitaInput(currentDate);
            }
        } catch (error) {
            console.error("Gagal mengisi tanggal otomatis:", error);
            showAlert('Kesalahan', 'Gagal memproses tanggal. Pastikan format tanggal benar.', 'error');
        }
    }
  </script>
</body>
</html>
