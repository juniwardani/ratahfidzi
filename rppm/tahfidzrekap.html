<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekap Penilaian Tahfidz - RA TAHFIDZI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0fdf4;
    }
    .btn {
      transition: all 0.2s ease-in-out;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .autocomplete {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d8;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d8;
    }
    .autocomplete-items div:hover {
      background-color: #e9e5ff;
    }
    .autocomplete-active {
      background-color: #e9e5ff !important;
    }
    
    /* Custom styles for dropdowns */
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
      transition: all 0.3s ease;
    }
    
    /* Unselected dropdown styles */
    select:invalid {
      background-color: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }
    
    /* Selected dropdown styles */
    select:valid {
      background-color: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }
    
    /* Disabled dropdown styles */
    select:disabled {
      background-color: #f3f4f6;
      border-color: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
    }
    
    /* Focus styles for all dropdowns */
    select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }
    
    /* Custom table styles */
    .assessment-table {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .assessment-table thead th {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .assessment-table tbody tr {
      transition: all 0.2s ease;
    }
    
    .assessment-table tbody tr:hover {
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    /* Modal centering styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed;
      inset: 0;
      background-color: rgba(31, 41, 55, 0.75);
      z-index: 50;
      padding: 1rem;
    }
    
    .modal.show {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }
    
    /* Responsive table styles */
    @media (max-width: 640px) {
      .table-container {
        overflow-x: visible;
      }
      
      .responsive-table {
        display: table;
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      .responsive-table thead {
        display: table-header-group;
      }
      
      .responsive-table thead th {
        display: table-cell;
        padding: 0.5rem;
        font-size: 0.65rem;
        background-color: #f0fdf4;
        border-bottom: 2px solid #10b981;
      }
      
      .responsive-table thead th:nth-child(1) {
        width: 10%;
      }
      
      .responsive-table thead th:nth-child(2) {
        width: 50%;
      }
      
      .responsive-table thead th:nth-child(3) {
        width: 20%;
      }
      
      .responsive-table thead th:nth-child(4) {
        width: 20%;
      }
      
      .responsive-table tbody {
        display: table-row-group;
      }
      
      .responsive-table tr {
        display: table-row;
        background: white;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .responsive-table tr:hover {
        background-color: #f0fdf4;
      }
      
      .responsive-table tr.striped-row {
        background-color: #f9fafb;
      }
      
      .responsive-table tr.striped-row:hover {
        background-color: #f0fdf4;
      }
      
      .responsive-table td {
        display: table-cell;
        padding: 0.5rem;
        font-size: 0.7rem;
        vertical-align: middle;
        border-bottom: 1px solid #f3f4f6;
      }
      
      .responsive-table td:nth-child(1) {
        width: 10%;
        text-align: center;
        font-weight: 600;
      }
      
      .responsive-table td:nth-child(2) {
        width: 50%;
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.2;
        max-width: 0;
        font-weight: 600;
        color: #047857;
      }
      
      .responsive-table td:nth-child(3) {
        width: 20%;
      }
      
      .responsive-table td:nth-child(4) {
        width: 20%;
      }
      
      .responsive-table select {
        width: 100%;
        font-size: 0.65rem;
        padding: 0.25rem 1.5rem 0.25rem 0.5rem;
      }
      
      /* Hide mobile-specific elements */
      .responsive-table .nama-cell::before,
      .responsive-table td::before {
        display: none;
      }
      
      .responsive-table .nama-cell {
        font-size: 0.7rem;
        padding: 0.5rem;
      }
    }
    
    /* Detail Modal Styles */
    .detail-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .detail-table th, .detail-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .detail-table th {
      background-color: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    
    .detail-table tr:hover {
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-gradient-to-r from-green-700 to-green-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <img src="img/logo.png" alt="Logo RA TAHFIDZI" class="h-10 w-10 object-contain">
            <h1 class="text-2xl font-bold tracking-wide">RA TAHFIDZI</h1>
        </div>
        <button id="header-logout-btn" class="hidden btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 sm:px-6 rounded-lg shadow-md text-sm sm:text-base">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      
      <!-- Login Form -->
      <div id="login-page">
          <div class="bg-white shadow-xl rounded-2xl max-w-md w-full p-8 mx-auto">
              <div class="text-center mb-8">
                  <h2 class="text-3xl font-bold text-green-700">Login Guru Tahfidz</h2>
                  <p class="text-gray-600 mt-2">Masuk untuk melihat rekap penilaian Tahfidz</p>
              </div>
              <div id="login-alert" class="text-red-600 mb-4 min-h-[1.5rem] text-center font-medium" role="alert"></div>
              <form id="login-form" class="space-y-6">
                  <select id="guru-login" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                      <option value="">Pilih Guru</option>
                  </select>
                  <input type="password" id="password-login" placeholder="Password" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" required />
                  <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition">Login</button>
              </form>
          </div>
      </div>

      <!-- Tahfidz Recap Page -->
      <div id="tahfidz-page" class="hidden">
          <div class="bg-white shadow-xl rounded-2xl p-8">
              <div class="mb-8">
                  <div class="flex justify-between items-center mb-6">
                      <h2 class="text-3xl font-bold text-green-700">Rekap Penilaian Tahfidz</h2>
                  </div>
                  <p class="text-gray-600">Selamat datang, <span id="user-name" class="font-semibold text-green-600"></span></p>
              </div>
              
              <!-- Filter Form -->
              <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl mb-6 shadow-inner">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                      <div>
                          <label for="kelas-input" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                          <input type="text" id="kelas-input" class="w-full border border-gray-300 rounded-lg p-3 bg-gray-100" readonly>
                      </div>
                      <div>
                          <label for="semester-select" class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                          <select id="semester-select" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500">
                              <option value="1">Semester I</option>
                              <option value="2">Semester II</option>
                          </select>
                      </div>
                      <div>
                          <label for="tanggal-select" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                          <input type="date" id="tanggal-select" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500">
                      </div>
                  </div>
                  
                  <!-- Filter Nama -->
                  <div class="mb-6">
                      <label for="nama-filter" class="block text-sm font-medium text-gray-700 mb-2">Filter Nama Siswa</label>
                      <div class="autocomplete">
                          <input type="text" id="nama-filter" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ketik nama siswa...">
                          <div id="nama-filter-list" class="autocomplete-items"></div>
                      </div>
                  </div>
              </div>
              
              <!-- Recap Table -->
              <div class="table-container mb-6 overflow-hidden rounded-xl shadow-lg border border-gray-200">
                  <table class="min-w-full divide-y divide-gray-200 assessment-table responsive-table">
                      <thead class="bg-gradient-to-r from-green-50 to-emerald-50">
                          <tr>
                              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">No</th>
                              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Nama Siswa</th>
                              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Penilaian</th>
                              <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Aksi</th>
                          </tr>
                      </thead>
                      <tbody id="recap-table-body" class="bg-white divide-y divide-gray-200">
                          <tr>
                              <td colspan="4" class="px-6 py-8 text-center text-gray-500 bg-gray-50">Pilih kelas dan semester untuk memuat data penilaian</td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              
              <!-- Action Buttons -->
              <div class="flex flex-col sm:flex-row justify-center gap-4">
                  <button id="kembali-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                      <i class="fas fa-arrow-left mr-2"></i>Kembali ke Penilaian
                  </button>
              </div>
          </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gradient-to-r from-green-800 to-green-700 text-green-100 py-4 mt-12">
      <div class="container mx-auto px-4 text-center text-sm">
          &copy; 2024 RA TAHFIDZI. Semua hak cipta dilindungi.
      </div>
  </footer>

  <!-- Detail Modal -->
  <div id="detail-modal" class="modal">
      <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 transform transition-all">
          <h3 class="text-xl font-bold text-green-700 mb-4">Detail Penilaian</h3>
          
          <div class="mb-6">
              <table class="detail-table">
                  <tr>
                      <th width="30%">Nama Siswa</th>
                      <td id="modal-nama-siswa" width="70%"></td>
                  </tr>
                  <tr>
                      <th>Kelas</th>
                      <td id="modal-kelas"></td>
                  </tr>
                  <tr>
                      <th>Semester</th>
                      <td id="modal-semester"></td>
                  </tr>
                  <tr>
                      <th>Tanggal</th>
                      <td id="modal-tanggal"></td>
                  </tr>
                  <tr>
                      <th>Surah</th>
                      <td id="modal-surah"></td>
                  </tr>
                  <tr>
                      <th>Penilaian</th>
                      <td id="modal-penilaian"></td>
                  </tr>
                  <tr>
                      <th>Keterangan</th>
                      <td id="modal-keterangan"></td>
                  </tr>
              </table>
          </div>
          
          <div class="flex justify-end">
              <button id="close-detail-btn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">
                  Tutup
              </button>
          </div>
      </div>
  </div>

  <script>
    // Kode Penilaian
    const kodePenilaian = [
      { kode: "BM", keterangan: "Belum Muncul" },
      { kode: "MM", keterangan: "Mulai Muncul" },
      { kode: "BSH", keterangan: "Berkembang Sesuai Harapan" },
      { kode: "BSB", keterangan: "Berkembang Sangat Baik" }
    ];

    // Supabase Configuration
    const supabaseUrl = 'https://hjvppgbcltgiibdxqtka.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqdnBwZ2JjbHRnaWliZHhxdGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyNzUzNDgsImV4cCI6MjA0OTg1MTM0OH0.3X7KMHg3qMdsgYsulWxC-hGvpjkGt-9V_YTbd7PSeOw';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // DOM Elements
    const loginPage = document.getElementById('login-page');
    const tahfidzPage = document.getElementById('tahfidz-page');
    const loginForm = document.getElementById('login-form');
    const guruLoginSelect = document.getElementById('guru-login');
    const passwordLoginInput = document.getElementById('password-login');
    const loginAlert = document.getElementById('login-alert');
    const headerLogoutBtn = document.getElementById('header-logout-btn');
    const userNameSpan = document.getElementById('user-name');
    const kelasInput = document.getElementById('kelas-input');
    const semesterSelect = document.getElementById('semester-select');
    const tanggalSelect = document.getElementById('tanggal-select');
    const recapTableBody = document.getElementById('recap-table-body');
    const namaFilter = document.getElementById('nama-filter');
    const namaFilterList = document.getElementById('nama-filter-list');
    const kembaliBtn = document.getElementById('kembali-btn');
    const detailModal = document.getElementById('detail-modal');
    const closeDetailBtn = document.getElementById('close-detail-btn');

    // State Variables
    let currentUser = null;
    let allSiswa = [];
    let allAssessments = [];
    let filteredAssessments = [];
    let currentKelas = '';
    let currentSemester = 1;
    let currentTanggal = '';

    // Initialize App
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
    });

    async function initializeApp() {
      // Check for existing session
      const sessionUser = localStorage.getItem('tahfidz_currentUser');
      if (sessionUser) {
        currentUser = JSON.parse(sessionUser);
        showTahfidzPage();
      } else {
        showLoginPage();
      }
      
      // Set today's date
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      tanggalSelect.value = formattedDate;
      currentTanggal = formattedDate;
      
      // Event Listeners
      loginForm.addEventListener('submit', handleLogin);
      headerLogoutBtn.addEventListener('click', handleLogout);
      semesterSelect.addEventListener('change', handleSemesterChange);
      tanggalSelect.addEventListener('change', handleTanggalChange);
      namaFilter.addEventListener('input', handleNamaFilter);
      kembaliBtn.addEventListener('click', () => window.location.href = 'tahfidz.html');
      closeDetailBtn.addEventListener('click', () => hideModal(detailModal));
      
      // Close modal when clicking outside
      detailModal.addEventListener('click', (e) => {
        if (e.target === detailModal) {
          hideModal(detailModal);
        }
      });
      
      // Populate dropdowns
      await populateGuruDropdown();
    }

    function showModal(modal) {
        modal.classList.add('show');
        // Add animation
        setTimeout(() => {
            modal.querySelector('.transform').classList.add('scale-100');
            modal.querySelector('.transform').classList.remove('scale-95');
        }, 10);
    }

    function hideModal(modal) {
        // Add animation
        modal.querySelector('.transform').classList.add('scale-95');
        modal.querySelector('.transform').classList.remove('scale-100');
        
        setTimeout(() => {
            modal.classList.remove('show');
        }, 200);
    }

    function showLoginPage() {
        loginPage.classList.remove('hidden');
        tahfidzPage.classList.add('hidden');
        headerLogoutBtn.classList.add('hidden');
    }

    function showTahfidzPage() {
        loginPage.classList.add('hidden');
        tahfidzPage.classList.remove('hidden');
        headerLogoutBtn.classList.remove('hidden');
        userNameSpan.textContent = currentUser.nama;
        
        // Load data for current user
        loadUserData();
    }

    async function populateGuruDropdown() {
        // Only fetch teachers with "Guru Tahfidz" position
        const { data, error } = await supabase.from('ra_guru').select('id, nama').eq('jabatan', 'Guru Tahfidz').order('nama');
        if (error) { 
            console.error('Error fetching gurus:', error); 
            loginAlert.textContent = 'Gagal memuat data guru. Silakan coba lagi.';
            return; 
        }
        
        guruLoginSelect.innerHTML = '<option value="">Pilih Guru</option>';
        data.forEach(guru => {
            const option = document.createElement('option');
            option.value = guru.id;
            option.textContent = guru.nama;
            guruLoginSelect.appendChild(option);
        });
    }

    async function handleLogin(e) {
        e.preventDefault();
        const guruId = guruLoginSelect.value;
        const password = passwordLoginInput.value;
        loginAlert.textContent = '';

        if (!guruId || !password) { 
            loginAlert.textContent = 'Silakan pilih guru dan masukkan password.'; 
            return; 
        }

        // Verify teacher credentials and position
        const { data: guru, error } = await supabase.from('ra_guru').select('*').eq('id', guruId).eq('jabatan', 'Guru Tahfidz').single();

        if (error || !guru || guru.password !== password) { 
            loginAlert.textContent = 'Username atau password salah, atau Anda bukan Guru Tahfidz.'; 
            return; 
        }

        currentUser = { id: guru.id, nama: guru.nama };
        localStorage.setItem('tahfidz_currentUser', JSON.stringify(currentUser));
        showTahfidzPage();
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('tahfidz_currentUser');
        passwordLoginInput.value = '';
        showLoginPage();
    }

    async function loadUserData() {
        try {
            // Get the class assigned to this teacher
            const { data: guruKelas, error: guruKelasError } = await supabase
                .from('ra_guru_kelas')
                .select('kelas_id')
                .eq('guru_id', currentUser.id)
                .single();
                
            if (guruKelasError) throw guruKelasError;
            
            // Get class details
            const { data: kelas, error: kelasError } = await supabase
                .from('ra_kelas')
                .select('*')
                .eq('id', guruKelas.kelas_id)
                .single();
                
            if (kelasError) throw kelasError;
            
            currentKelas = kelas.nama_kelas.charAt(0); // Get just 'A' or 'B' from 'A1', 'A2', etc.
            kelasInput.value = kelas.nama_kelas;
            
            // Load students for this class
            await loadSiswaData();
            
            // Load assessment data
            await loadAssessmentData();
            
            // Filter and display data
            filterAssessments();
        } catch (error) {
            console.error('Error loading user data:', error);
            alert('Gagal memuat data. Silakan coba lagi.');
        }
    }

    async function loadSiswaData() {
        try {
            // Get the class assigned to this teacher
            const { data: guruKelas, error: guruKelasError } = await supabase
                .from('ra_guru_kelas')
                .select('kelas_id')
                .eq('guru_id', currentUser.id)
                .single();
                
            if (guruKelasError) throw guruKelasError;
            
            // Get all students in this class
            const { data: siswa, error: siswaError } = await supabase
                .from('ra_siswa')
                .select('*')
                .eq('kelas_id', guruKelas.kelas_id)
                .order('nama');
                
            if (siswaError) throw siswaError;
            
            allSiswa = siswa;
        } catch (error) {
            console.error('Error loading siswa data:', error);
            alert('Gagal memuat data siswa.');
        }
    }

    async function loadAssessmentData() {
        try {
            // Get all assessment data for this class and semester
            const { data, error } = await supabase
                .from('ra_tahfidz')
                .select('*')
                .eq('kelas', kelasInput.value)
                .eq('semester', currentSemester)
                .order('tanggal', { ascending: false })
                .order('created_at', { ascending: false });
                
            if (error) throw error;
            
            allAssessments = data || [];
            filteredAssessments = [...allAssessments];
        } catch (error) {
            console.error('Error loading assessment data:', error);
            alert('Gagal memuat data penilaian.');
        }
    }

    function updateRecapTable() {
        recapTableBody.innerHTML = '';
        
        if (filteredAssessments.length === 0) {
            recapTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500 bg-gray-50">Tidak ada data penilaian yang cocok dengan filter.</td></tr>`;
            return;
        }
        
        filteredAssessments.forEach((assessment, index) => {
            // Find student name
            const siswa = allSiswa.find(s => s.id === assessment.siswa_id);
            const namaSiswa = siswa ? siswa.nama : 'Unknown';
            
            const row = document.createElement('tr');
            row.className = 'striped-row hover:bg-green-50 transition-all duration-200';
            
            // Desktop layout
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold nama-siswa-cell">${namaSiswa}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="px-2 py-1 text-xs rounded-full ${getPenilaianColorClass(assessment.penilaian)}">
                        ${assessment.penilaian}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <button class="detail-btn bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded" data-assessment-id="${assessment.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            
            // Mobile layout attributes
            row.querySelector('td:first-child').setAttribute('data-label', 'No');
            row.querySelector('td:first-child').setAttribute('data-no', index + 1);
            row.querySelector('td:nth-child(2)').setAttribute('data-label', 'Nama Siswa');
            row.querySelector('td:nth-child(2)').classList.add('nama-cell');
            row.querySelector('td:nth-child(3)').setAttribute('data-label', 'Penilaian');
            row.querySelector('td:nth-child(4)').setAttribute('data-label', 'Aksi');
            
            recapTableBody.appendChild(row);
            
            // Add event listener for detail button
            const detailBtn = row.querySelector('.detail-btn');
            detailBtn.addEventListener('click', () => showDetailModal(assessment.id));
        });
    }

    function showDetailModal(assessmentId) {
        const assessment = allAssessments.find(a => a.id === assessmentId);
        if (!assessment) return;
        
        // Find student name
        const siswa = allSiswa.find(s => s.id === assessment.siswa_id);
        const namaSiswa = siswa ? siswa.nama : 'Unknown';
        
        // Find penilaian description
        const penilaianDesc = kodePenilaian.find(k => k.kode === assessment.penilaian);
        const penilaianText = penilaianDesc ? `${assessment.penilaian} - ${penilaianDesc.keterangan}` : assessment.penilaian;
        
        // Populate modal
        document.getElementById('modal-nama-siswa').textContent = namaSiswa;
        document.getElementById('modal-kelas').textContent = assessment.kelas;
        document.getElementById('modal-semester').textContent = `Semester ${assessment.semester}`;
        document.getElementById('modal-tanggal').textContent = formatDate(assessment.tanggal);
        document.getElementById('modal-surah').textContent = assessment.surah;
        document.getElementById('modal-penilaian').textContent = penilaianText;
        document.getElementById('modal-keterangan').textContent = assessment.keterangan || '-';
        
        showModal(detailModal);
    }

    function handleSemesterChange(e) {
        currentSemester = parseInt(e.target.value);
        loadAssessmentData().then(() => {
            filterAssessments();
        });
    }

    function handleTanggalChange(e) {
        currentTanggal = e.target.value;
        filterAssessments();
    }

    function handleNamaFilter(e) {
        const filterValue = e.target.value.toLowerCase();
        
        if (filterValue === '') {
            updateRecapTable();
            namaFilterList.innerHTML = '';
            return;
        }
        
        // Get unique student IDs from assessments
        const uniqueStudentIds = [...new Set(allAssessments.map(a => a.siswa_id))];
        
        // Filter students who have assessment data
        const matchingSiswa = allSiswa.filter(siswa => 
            uniqueStudentIds.includes(siswa.id) && 
            siswa.nama.toLowerCase().includes(filterValue)
        );
        
        namaFilterList.innerHTML = '';
        matchingSiswa.forEach(siswa => {
            const item = document.createElement('div');
            item.textContent = siswa.nama;
            item.addEventListener('click', () => {
                namaFilter.value = siswa.nama;
                namaFilterList.innerHTML = '';
                filterAssessments();
            });
            namaFilterList.appendChild(item);
        });
        
        // Auto-filter when typing
        filterAssessments();
    }

    function filterAssessments() {
        const filterDate = currentTanggal;
        const namaFilterValue = namaFilter.value.toLowerCase();
        
        filteredAssessments = allAssessments.filter(assessment => {
            // Filter by date
            const dateMatch = assessment.tanggal === filterDate;
            
            // Filter by student name
            const siswa = allSiswa.find(s => s.id === assessment.siswa_id);
            const namaMatch = siswa ? siswa.nama.toLowerCase().includes(namaFilterValue) : false;
            
            return dateMatch && namaMatch;
        });
        
        updateRecapTable();
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('id-ID', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric' 
        });
    }

    function getPenilaianColorClass(penilaian) {
        switch(penilaian) {
            case 'BM': return 'bg-red-100 text-red-800';
            case 'MM': return 'bg-yellow-100 text-yellow-800';
            case 'BSH': return 'bg-blue-100 text-blue-800';
            case 'BSB': return 'bg-green-100 text-green-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }
  </script>
</body>
</html>
