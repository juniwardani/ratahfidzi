<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi RA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Main Application -->
    <div id="mainApp">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-school text-2xl text-blue-500 mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-800">Sistem Absensi RA</h1>
                </div>
                <div class="text-gray-600">
                    <i class="fas fa-user-circle mr-2"></i>
                    <span>Administrator</span>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-blue-500 text-white">
            <div class="container mx-auto px-4">
                <div class="flex space-x-1">
                    <button class="tab-btn py-3 px-6 hover:bg-blue-600 transition duration-300 rounded-t-lg bg-blue-600" data-tab="dashboard">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button class="tab-btn py-3 px-6 hover:bg-blue-600 transition duration-300 rounded-t-lg" data-tab="rekap">
                        <i class="fas fa-chart-bar mr-2"></i>Rekap
                    </button>
                    <button class="tab-btn py-3 px-6 hover:bg-blue-600 transition duration-300 rounded-t-lg" data-tab="analisis">
                        <i class="fas fa-chart-line mr-2"></i>Analisis
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="container mx-auto px-4 py-6">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-500 mr-4">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">Total Siswa</p>
                                <p id="totalSiswa" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-500 mr-4">
                                <i class="fas fa-user-check text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">Hadir Hari Ini</p>
                                <p id="hadirHariIni" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-500 mr-4">
                                <i class="fas fa-procedures text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">Sakit Hari Ini</p>
                                <p id="sakitHariIni" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100 text-red-500 mr-4">
                                <i class="fas fa-user-times text-xl"></i>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">Alpa Hari Ini</p>
                                <p id="alpaHariIni" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Grafik Kehadiran Mingguan</h2>
                            <div class="flex space-x-2">
                                <select id="weeklyMonth" class="px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3">Maret</option>
                                    <option value="4">April</option>
                                    <option value="5">Mei</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">Agustus</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                                <select id="weeklyWeek" class="px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="1">Minggu 1</option>
                                    <option value="2">Minggu 2</option>
                                    <option value="3">Minggu 3</option>
                                    <option value="4">Minggu 4</option>
                                    <option value="5">Minggu 5</option>
                                </select>
                                <button id="filterWeeklyBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md transition duration-300">
                                    Filter
                                </button>
                            </div>
                        </div>
                        <canvas id="weeklyChart" width="400" height="200"></canvas>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Grafik Kehadiran Bulanan</h2>
                            <div class="flex space-x-2">
                                <select id="monthlyMonth" class="px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3">Maret</option>
                                    <option value="4">April</option>
                                    <option value="5">Mei</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">Agustus</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                                <button id="filterMonthlyBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md transition duration-300">
                                    Filter
                                </button>
                            </div>
                        </div>
                        <canvas id="monthlyChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Rekap Tab -->
            <div id="rekapTab" class="tab-content hidden fade-in">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Rekap Kehadiran</h2>
                    <div class="mb-4 flex flex-wrap gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="rekapKelas">Kelas</label>
                            <select id="rekapKelas" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="rekapBulan">Bulan</label>
                            <select id="rekapBulan" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="rekapTahun">Tahun</label>
                            <input id="rekapTahun" type="number" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div id="rekapContainer" class="hidden">
                        <div class="mb-6">
                            <canvas id="rekapChart" width="400" height="200"></canvas>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 text-left text-gray-700">Nama Siswa</th>
                                        <th class="py-2 px-4 text-center text-gray-700">Hadir</th>
                                        <th class="py-2 px-4 text-center text-gray-700">Sakit</th>
                                        <th class="py-2 px-4 text-center text-gray-700">Izin</th>
                                        <th class="py-2 px-4 text-center text-gray-700">Alpa</th>
                                        <th class="py-2 px-4 text-center text-gray-700">Persentase Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody id="rekapTable">
                                    <!-- Data rekap akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analisis Tab -->
            <div id="analisisTabContent" class="tab-content hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Siswa dengan Kehadiran Rendah (&lt;75%)</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 text-left text-gray-700">Nama Siswa</th>
                                        <th class="py-2 px-4 text-left text-gray-700">Kelas</th>
                                        <th class="py-2 px-4 text-center text-gray-700">Persentase Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody id="siswaRendahTable">
                                    <!-- Data siswa dengan kehadiran rendah akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Perbandingan Kehadiran Antar Kelas</h2>
                        <canvas id="kelasComparisonChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Guru Paling Aktif Input Absensi</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-4 text-left text-gray-700">Nama Guru</th>
                                    <th class="py-2 px-4 text-left text-gray-700">Jabatan</th>
                                    <th class="py-2 px-4 text-center text-gray-700">Jumlah Input</th>
                                </tr>
                            </thead>
                            <tbody id="guruAktifTable">
                                <!-- Data guru aktif akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-lg shadow-xl">
            <div class="flex items-center">
                <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full border-blue-500 border-t-transparent" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <span class="ml-2">Memuat data...</span>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="notificationText">Notifikasi</span>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://hjvppgbcltgiibdxqtka.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqdnBwZ2JjbHRnaWliZHhxdGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyNzUzNDgsImV4cCI6MjA0OTg1MTM0OH0.3X7KMHg3qMdsgYsulWxC-hGvpjkGt-9V_YTbd7PSeOw';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let weeklyChart = null;
        let monthlyChart = null;
        let rekapChart = null;
        let kelasComparisonChart = null;

        // DOM elements
        const loadingSpinner = document.getElementById('loadingSpinner');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rekapTahun').value = new Date().getFullYear();
            document.getElementById('rekapBulan').value = new Date().getMonth() + 1;
            
            // Set default values for weekly chart filters
            document.getElementById('weeklyMonth').value = new Date().getMonth() + 1;
            document.getElementById('weeklyWeek').value = 1;
            
            // Set default values for monthly chart filter
            document.getElementById('monthlyMonth').value = new Date().getMonth() + 1;

            // Event listeners
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            document.getElementById('filterWeeklyBtn').addEventListener('click', () => {
                            const month = document.getElementById('weeklyMonth').value;
                            const week = document.getElementById('weeklyWeek').value;
                            generateWeeklyChart(month, week);
                        });
            document.getElementById('filterMonthlyBtn').addEventListener('click', () => {
                            // For monthly chart, we don't need parameters as it reads from its own dropdown
                            generateMonthlyChart();
                        });
            
            // Add event listeners for automatic rekap loading
            document.getElementById('rekapKelas').addEventListener('change', tampilkanRekap);
            document.getElementById('rekapBulan').addEventListener('change', tampilkanRekap);
            document.getElementById('rekapTahun').addEventListener('change', tampilkanRekap);

            // Load initial data
            loadDashboardData();
            loadKelasOptions();
        });

        // Switch tab function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
            });

            // Show selected tab
            const selectedTab = document.getElementById(`${tabName}Tab`);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            } else if (tabName === 'analisis') {
                document.getElementById('analisisTabContent').classList.remove('hidden');
            }

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('bg-blue-600');
            }

            // Load data based on selected tab
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'analisis') {
                loadAnalisisData();
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            showLoading(true);
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Get total students
                const { data: siswaData, error: siswaError } = await supabaseClient
                    .from('ra_siswa')
                    .select('*');
                
                if (siswaError) throw siswaError;
                document.getElementById('totalSiswa').textContent = siswaData.length;

                // Get today's attendance
                const { data: absensiData, error: absensiError } = await supabaseClient
                    .from('ra_absensi')
                    .select('*')
                    .eq('tanggal', today);
                
                if (absensiError) throw absensiError;
                
                // Count attendance status
                const hadirCount = absensiData.filter(a => a.status === 'hadir').length;
                const sakitCount = absensiData.filter(a => a.status === 'sakit').length;
                const alpaCount = absensiData.filter(a => a.status === 'alpha').length;
                
                document.getElementById('hadirHariIni').textContent = hadirCount;
                document.getElementById('sakitHariIni').textContent = sakitCount;
                document.getElementById('alpaHariIni').textContent = alpaCount;

                // Generate weekly chart data
                await generateWeeklyChart();
                
                // Generate monthly chart data
                await generateMonthlyChart();
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Gagal memuat data dashboard', 'error');
                showLoading(false);
            }
        }

        // Generate weekly chart
        async function generateWeeklyChart(month, week) {
            try {
                // Get selected month and week
                let selectedMonth = month || document.getElementById('weeklyMonth').value;
                let selectedWeek = week || document.getElementById('weeklyWeek').value;
                
                // If no parameters provided and no DOM elements, use current month/week 1 as default
                if (!selectedMonth && !selectedWeek) {
                    selectedMonth = new Date().getMonth() + 1;
                    selectedWeek = 1;
                } else {
                    // Parse and validate inputs
                    selectedMonth = parseInt(selectedMonth, 10);
                    selectedWeek = parseInt(selectedWeek, 10);
                    
                    if (isNaN(selectedMonth) || isNaN(selectedWeek) || selectedMonth < 1 || selectedMonth > 12 || selectedWeek < 1 || selectedWeek > 5) {
                        throw new Error('Invalid month or week selection');
                    }
                }
                const currentYear = new Date().getFullYear();
                
                // Calculate date range for the selected week
                // Create a valid date for the first day of the selected month
                const firstDayOfMonth = new Date(currentYear, selectedMonth - 1, 1);
                
                // Calculate the first day of the selected week
                const firstDayOfWeek = new Date(firstDayOfMonth);
                firstDayOfWeek.setDate(firstDayOfMonth.getDate() + (selectedWeek - 1) * 7);
                
                // Calculate the last day of the selected week
                const lastDayOfWeek = new Date(firstDayOfWeek);
                lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);
                
                // Ensure we don't go beyond the end of the month
                const lastDayOfMonth = new Date(currentYear, selectedMonth, 0);
                if (lastDayOfWeek > lastDayOfMonth) {
                    lastDayOfWeek.setTime(lastDayOfMonth.getTime());
                }
                
                // Validate dates
                if (isNaN(firstDayOfWeek.getTime()) || isNaN(lastDayOfWeek.getTime())) {
                    throw new Error('Invalid date range calculated');
                }
                
                const { data, error } = await supabaseClient
                    .from('ra_absensi')
                    .select('tanggal, status')
                    .gte('tanggal', firstDayOfWeek.toISOString().split('T')[0])
                    .lte('tanggal', lastDayOfWeek.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                // Process data for chart
                const chartData = {};
                const labels = [];
                
                // Initialize chart data for each day in the selected week
                // Calculate the actual number of days in the week (could be less than 7 at month boundaries)
                const timeDiff = lastDayOfWeek.getTime() - firstDayOfWeek.getTime();
                const daysInWeek = Math.min(7, Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1);
                for (let i = 0; i < daysInWeek; i++) {
                    const date = new Date(firstDayOfWeek);
                    date.setDate(firstDayOfWeek.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' });
                    const dayDate = date.toLocaleDateString('id-ID', { day: '2-digit' });
                    
                    labels.push(`${dayName} ${dayDate}`);
                    chartData[dateStr] = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
                }
                
                // Fill chart data with actual values
                data.forEach(item => {
                    if (chartData[item.tanggal]) {
                        chartData[item.tanggal][item.status]++;
                    }
                });
                
                // Prepare data for chart
                const hadirData = Object.values(chartData).map(d => d.hadir);
                const sakitData = Object.values(chartData).map(d => d.sakit);
                const izinData = Object.values(chartData).map(d => d.izin);
                const alpaData = Object.values(chartData).map(d => d.alpha);
                
                // Create or update chart
                const ctx = document.getElementById('weeklyChart').getContext('2d');
                
                if (weeklyChart) {
                    weeklyChart.destroy();
                }
                
                weeklyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Hadir',
                                data: hadirData,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            },
                            {
                                label: 'Sakit',
                                data: sakitData,
                                borderColor: 'rgb(255, 205, 86)',
                                backgroundColor: 'rgba(255, 205, 86, 0.2)',
                                tension: 0.1
                            },
                            {
                                label: 'Izin',
                                data: izinData,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.1
                            },
                            {
                                label: 'Alpa',
                                data: alpaData,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error generating weekly chart:', error);
            }
        }

        // Generate monthly chart
        async function generateMonthlyChart() {
            try {
                // Get selected month
                const selectedMonth = document.getElementById('monthlyMonth').value;
                const currentYear = new Date().getFullYear();
                const firstDayOfMonth = new Date(currentYear, selectedMonth - 1, 1);
                const lastDayOfMonth = new Date(currentYear, selectedMonth, 0);
                
                const { data, error } = await supabaseClient
                    .from('ra_absensi')
                    .select('tanggal, status')
                    .gte('tanggal', firstDayOfMonth.toISOString().split('T')[0])
                    .lte('tanggal', lastDayOfMonth.toISOString().split('T')[0]);
                
                if (error) throw error;
                
                // Process data for chart
                const chartData = {};
                
                // Initialize chart data for each week (up to 5 weeks)
                const maxWeeks = Math.ceil((lastDayOfMonth.getDate() + firstDayOfMonth.getDay()) / 7);
                for (let i = 1; i <= maxWeeks; i++) {
                    chartData[`Minggu ${i}`] = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
                }
                
                // Fill chart data with actual values
                data.forEach(item => {
                    const date = new Date(item.tanggal);
                    // Calculate week of month correctly
                    const firstDay = firstDayOfMonth.getDay() || 7; // Convert 0 (Sun) to 7
                    const dayOfMonth = date.getDate();
                    const weekOfMonth = Math.ceil((dayOfMonth + firstDay - 1) / 7);
                    
                    // Handle months with 5 weeks
                    const maxWeeks = Math.ceil((lastDayOfMonth.getDate() + firstDayOfMonth.getDay() - 1) / 7);
                    
                    if (weekOfMonth >= 1 && weekOfMonth <= maxWeeks) {
                        chartData[`Minggu ${weekOfMonth}`][item.status]++;
                    }
                });
                
                // Prepare data for chart
                const labels = Object.keys(chartData);
                const hadirData = Object.values(chartData).map(d => d.hadir);
                const sakitData = Object.values(chartData).map(d => d.sakit);
                const izinData = Object.values(chartData).map(d => d.izin);
                const alpaData = Object.values(chartData).map(d => d.alpha);
                
                // Create or update chart
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                
                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Hadir',
                                data: hadirData,
                                backgroundColor: 'rgba(75, 192, 192, 0.8)'
                            },
                            {
                                label: 'Sakit',
                                data: sakitData,
                                backgroundColor: 'rgba(255, 205, 86, 0.8)'
                            },
                            {
                                label: 'Izin',
                                data: izinData,
                                backgroundColor: 'rgba(54, 162, 235, 0.8)'
                            },
                            {
                                label: 'Alpa',
                                data: alpaData,
                                backgroundColor: 'rgba(255, 99, 132, 0.8)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error generating monthly chart:', error);
            }
        }

        // Load class options
        async function loadKelasOptions() {
            try {
                const { data, error } = await supabaseClient
                    .from('ra_kelas')
                    .select('*');
                
                if (error) throw error;
                
                // Update class dropdown
                const rekapKelas = document.getElementById('rekapKelas');
                
                // Clear existing options
                rekapKelas.innerHTML = '<option value="">Pilih Kelas</option>';
                
                // Add new options
                data.forEach(kelas => {
                    const option = document.createElement('option');
                    option.value = kelas.id;
                    option.textContent = kelas.nama_kelas;
                    rekapKelas.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading class options:', error);
                showNotification('Gagal memuat data kelas', 'error');
            }
        }

        // Show attendance recap
        async function tampilkanRekap() {
            const kelasId = document.getElementById('rekapKelas').value;
            const bulan = document.getElementById('rekapBulan').value;
            const tahun = document.getElementById('rekapTahun').value;
            
            if (!kelasId || !bulan || !tahun) {
                // Don't show error, just return silently when fields are not filled
                return;
            }
            
            showLoading(true);
            
            try {
                // Get students in the selected class
                const { data: siswaData, error: siswaError } = await supabaseClient
                    .from('ra_siswa')
                    .select('*')
                    .eq('kelas_id', kelasId)
                    .order('no');
                
                if (siswaError) throw siswaError;
                
                // Get attendance data for the selected month
                const startDate = `${tahun}-${bulan.padStart(2, '0')}-01`;
                // Calculate the last day of the month correctly
                const lastDay = new Date(tahun, parseInt(bulan), 0).getDate();
                const endDate = `${tahun}-${bulan.padStart(2, '0')}-${lastDay.toString().padStart(2, '0')}`;
                
                const { data: absensiData, error: absensiError } = await supabaseClient
                    .from('ra_absensi')
                    .select('*')
                    .gte('tanggal', startDate)
                    .lte('tanggal', endDate)
                    .in('siswa_id', siswaData.map(s => s.id));
                
                if (absensiError) throw absensiError;
                
                // Process attendance data for each student
                const recapData = siswaData.map(siswa => {
                    const studentAttendance = absensiData.filter(a => a.siswa_id === siswa.id);
                    
                    const hadirCount = studentAttendance.filter(a => a.status === 'hadir').length;
                    const sakitCount = studentAttendance.filter(a => a.status === 'sakit').length;
                    const izinCount = studentAttendance.filter(a => a.status === 'izin').length;
                    const alpaCount = studentAttendance.filter(a => a.status === 'alpha').length;
                    const totalCount = studentAttendance.length;
                    
                    const persentaseHadir = totalCount > 0 ? Math.round((hadirCount / totalCount) * 100) : 0;
                    
                    return {
                        id: siswa.id,
                        nama: siswa.nama,
                        hadir: hadirCount,
                        sakit: sakitCount,
                        izin: izinCount,
                        alpha: alpaCount,
                        persentase: persentaseHadir
                    };
                });
                
                // Display recap data in table
                const tableBody = document.getElementById('rekapTable');
                tableBody.innerHTML = '';
                
                recapData.forEach(data => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    
                    row.innerHTML = `
                        <td class="py-2 px-4">${data.nama}</td>
                        <td class="py-2 px-4 text-center">${data.hadir}</td>
                        <td class="py-2 px-4 text-center">${data.sakit}</td>
                        <td class="py-2 px-4 text-center">${data.izin}</td>
                        <td class="py-2 px-4 text-center">${data.alpha}</td>
                        <td class="py-2 px-4 text-center">${data.persentase}%</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Generate recap chart
                const ctx = document.getElementById('rekapChart').getContext('2d');
                
                if (rekapChart) {
                    rekapChart.destroy();
                }
                
                rekapChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Hadir', 'Sakit', 'Izin', 'Alpa'],
                        datasets: [{
                            label: 'Jumlah',
                            data: [
                                recapData.reduce((sum, d) => sum + d.hadir, 0),
                                recapData.reduce((sum, d) => sum + d.sakit, 0),
                                recapData.reduce((sum, d) => sum + d.izin, 0),
                                recapData.reduce((sum, d) => sum + d.alpha, 0)
                            ],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(255, 205, 86, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 99, 132, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Show the container
                document.getElementById('rekapContainer').classList.remove('hidden');
                
                showLoading(false);
            } catch (error) {
                console.error('Error displaying recap:', error);
                showNotification('Gagal memuat data rekap', 'error');
                showLoading(false);
            }
        }

        // Load analysis data
        async function loadAnalisisData() {
            showLoading(true);
            
            try {
                // Get students with low attendance (<75%)
                await loadSiswaRendah();
                
                // Get class comparison data
                await loadKelasComparison();
                
                // Get active teachers
                await loadGuruAktif();
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading analysis data:', error);
                showNotification('Gagal memuat data analisis', 'error');
                showLoading(false);
            }
        }

        // Load students with low attendance
        async function loadSiswaRendah() {
            try {
                // Get all students
                const { data: siswaData, error: siswaError } = await supabaseClient
                    .from('ra_siswa')
                    .select('*, ra_kelas(*)');
                
                if (siswaError) throw siswaError;
                
                // Get all attendance data
                const { data: absensiData, error: absensiError } = await supabaseClient
                    .from('ra_absensi')
                    .select('*');
                
                if (absensiError) throw absensiError;
                
                // Process attendance data for each student
                const siswaRendah = [];
                
                siswaData.forEach(siswa => {
                    const studentAttendance = absensiData.filter(a => a.siswa_id === siswa.id);
                    
                    const hadirCount = studentAttendance.filter(a => a.status === 'hadir').length;
                    const totalCount = studentAttendance.length;
                    
                    if (totalCount > 0) {
                        const persentaseHadir = Math.round((hadirCount / totalCount) * 100);
                        
                        if (persentaseHadir < 75) {
                            siswaRendah.push({
                                nama: siswa.nama,
                                kelas: siswa.ra_kelas ? siswa.ra_kelas.nama_kelas : 'Kelas tidak ditemukan',
                                persentase: persentaseHadir
                            });
                        }
                    }
                });
                
                // Display data in table
                const tableBody = document.getElementById('siswaRendahTable');
                tableBody.innerHTML = '';
                
                if (siswaRendah.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="3" class="py-2 px-4 text-center">Tidak ada siswa dengan kehadiran rendah</td>`;
                    tableBody.appendChild(row);
                } else {
                    siswaRendah.forEach(data => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        
                        row.innerHTML = `
                            <td class="py-2 px-4">${data.nama}</td>
                            <td class="py-2 px-4">${data.kelas}</td>
                            <td class="py-2 px-4 text-center">${data.persentase}%</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading students with low attendance:', error);
                throw error;
            }
        }

        // Load class comparison data
        async function loadKelasComparison() {
            try {
                // Get all classes
                const { data: kelasData, error: kelasError } = await supabaseClient
                    .from('ra_kelas')
                    .select('*');
                
                if (kelasError) throw kelasError;
                
                // Get all students
                const { data: siswaData, error: siswaError } = await supabaseClient
                    .from('ra_siswa')
                    .select('*');
                
                if (siswaError) throw siswaError;
                
                // Get all attendance data
                const { data: absensiData, error: absensiError } = await supabaseClient
                    .from('ra_absensi')
                    .select('*');
                
                if (absensiError) throw absensiError;
                
                // Process attendance data for each class
                const kelasStats = [];
                
                kelasData.forEach(kelas => {
                    const studentsInClass = siswaData.filter(s => s.kelas_id === kelas.id);
                    const classAttendance = absensiData.filter(a => 
                        studentsInClass.some(s => s.id === a.siswa_id)
                    );
                    
                    const hadirCount = classAttendance.filter(a => a.status === 'hadir').length;
                    const totalCount = classAttendance.length;
                    
                    const persentaseHadir = totalCount > 0 ? Math.round((hadirCount / totalCount) * 100) : 0;
                    
                    kelasStats.push({
                        nama: kelas.nama_kelas,
                        persentase: persentaseHadir
                    });
                });
                
                // Generate comparison chart
                const ctx = document.getElementById('kelasComparisonChart').getContext('2d');
                
                if (kelasComparisonChart) {
                    kelasComparisonChart.destroy();
                }
                
                kelasComparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: kelasStats.map(k => k.nama),
                        datasets: [{
                            label: 'Persentase Kehadiran',
                            data: kelasStats.map(k => k.persentase),
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading class comparison data:', error);
                throw error;
            }
        }

        // Load active teachers
        async function loadGuruAktif() {
            try {
                // Get all teachers
                const { data: guruData, error: guruError } = await supabaseClient
                    .from('ra_guru')
                    .select('*');
                
                if (guruError) throw guruError;
                
                // Get all attendance data
                const { data: absensiData, error: absensiError } = await supabaseClient
                    .from('ra_absensi')
                    .select('created_by');
                
                if (absensiError) throw absensiError;
                
                // Count attendance entries by teacher
                const guruStats = guruData.map(guru => {
                    const inputCount = absensiData.filter(a => a.created_by === guru.id).length;
                    
                    return {
                        nama: guru.nama,
                        jabatan: guru.jabatan,
                        inputCount: inputCount
                    };
                });
                
                // Sort by input count (descending)
                guruStats.sort((a, b) => b.inputCount - a.inputCount);
                
                // Display data in table
                const tableBody = document.getElementById('guruAktifTable');
                tableBody.innerHTML = '';
                
                guruStats.forEach(data => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    
                    row.innerHTML = `
                        <td class="py-2 px-4">${data.nama}</td>
                        <td class="py-2 px-4">${data.jabatan}</td>
                        <td class="py-2 px-4 text-center">${data.inputCount}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading active teachers:', error);
                throw error;
            }
        }

        // Show loading spinner
        function showLoading(show) {
            if (show) {
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            notificationText.textContent = message;
            
            if (type === 'error') {
                notification.classList.remove('bg-green-500');
                notification.classList.add('bg-red-500');
            } else {
                notification.classList.remove('bg-red-500');
                notification.classList.add('bg-green-500');
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
