<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Inventaris RA Tahfidzi</title>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Gaya Umum */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        h1, h2 {
            color: #28a745;
            text-align: center;
        }

        /* Gaya Form */
        .form-container {
            background-color: #d4edda;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* Gaya Tombol */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.2s;
            white-space: nowrap; /* Mencegah teks tombol pecah baris */
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary { background-color: #28a745; color: white; }
        .btn-primary:hover { background-color: #218838; }
        .btn-success { background-color: #20c997; color: white; }
        .btn-success:hover { background-color: #1aa179; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }

        .btn-container {
            text-align: center;
            margin: 20px 0;
        }

        /* Gaya Tabel */
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 800px; /* Lebar minimum disesuaikan */
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #28a745;
            color: white;
        }
        
        th:nth-child(5), th:nth-child(6), th:nth-child(7) {
            text-align: center;
        }
        
        td:nth-child(5), td:nth-child(6), td:nth-child(7) {
            text-align: center;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center; /* Pastikan tombol selalu di tengah */
        }
        
        /* --- FITUR STICKY COLUMN (HANYA UNTUK NAMA BARANG) --- */
        th:nth-child(1), td:nth-child(1) {
            width: 50px;
            min-width: 50px;
        }

        th:nth-child(2),
        td:nth-child(2) {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #28a745;
            color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            max-width: 250px;
            min-width: 150px;
            /* PERUBAHAN: Memungkinkan teks untuk ter-enter ke bawah */
            overflow-wrap: break-word;
            word-wrap: break-word; /* Untuk kompatibilitas browser lama */
            white-space: normal;
        }
        td:nth-child(2) {
            color: #000;
            background-color: #fff;
        }
        tr:nth-child(even) td:nth-child(2) {
            color: #000;
            background-color: #f2f2f2;
        }

        th:last-child, td:last-child {
            width: 180px;
            min-width: 180px;
            text-align: center;
        }
        
        /* --- MEDIA QUERY UNTUK RESPONSIVITAS --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 24px; }
            h2 { font-size: 20px; }
            .btn { font-size: 14px; padding: 8px 15px; }
            .form-group { margin-bottom: 10px; }
            th, td { padding: 8px 5px; font-size: 14px; }
            .action-buttons .btn { padding: 5px 8px; font-size: 12px; }
        }

        /* Custom Alert Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            transform: scale(0.8);
            transition: transform 0.3s;
            overflow: hidden;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
            flex-shrink: 0;
        }

        .modal-icon.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .modal-icon.error {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-body {
            padding: 20px;
            color: #333;
            line-height: 1.5;
        }

        .modal-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #eee;
        }

        .modal-button {
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-button.primary {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login Section (Optional, for future use) -->
        <div id="loginSection" style="display: none;">
            <h2>Login</h2>
            <!-- Login form can be added here -->
        </div>

        <h1>Aplikasi Inventaris Sarana dan Prasarana</h1>
        <h2>RA Tahfidzi</h2>

        <!-- Form untuk Tambah/Edit Barang -->
        <div id="formContainer" class="form-container">
            <h2 id="judulForm">Tambah Barang Baru</h2>
            <form id="formInventaris">
                <input type="hidden" id="barangId">
                <div class="form-group">
                    <label for="namaBarang">Nama Barang:</label>
                    <input type="text" id="namaBarang" required>
                </div>
                <div class="form-group">
                    <label for="kategori">Kategori:</label>
                    <select id="kategori" required>
                        <option value="">-- Pilih Kategori --</option>
                        <optgroup label="I. SARANA">
                            <option value="Perabot (Mebelair)" title="contoh: kursi dan meja siswa serta lemari arsip">Perabot (Mebelair)</option>
                            <option value="Peralatan Pendidikan (Non-Elektronik)" title="contoh: papan tulis konvensional dan globe">Peralatan Pendidikan (Non-Elektronik)</option>
                            <option value="Buku dan Sumber Belajar" title="contoh: buku teks pelajaran dan buku bacaan fiksi untuk perpustakaan">Buku dan Sumber Belajar</option>
                            <option value="Sarana Olahraga" title="contoh: bola basket atau sepak bola serta net voli atau tenis">Sarana Olahraga</option>
                            <option value="Sarana Kesenian" title="contoh: gitar atau keyboard serta peralatan melukis atau pahat">Sarana Kesenian</option>
                            <option value="Sarana Keselamatan" title="contoh: kotak P3K dan APAR">Sarana Keselamatan</option>
                            <option value="Peralatan Elektronik" title="contoh: laptop atau komputer serta proyektor LCD">Peralatan Elektronik</option>
                            <option value="Permainan Pendidikan" title="contoh: puzzle dan balok susun">Permainan Pendidikan</option>
                            <option value="Alat Peraga Edukatif (APE)" title="contoh: kartu huruf/angka dan papan geometri">Alat Peraga Edukatif (APE)</option>
                        </optgroup>
                        <optgroup label="II. PRASARANA (Bangunan dan Lahan)">
                            <option value="Bangunan/Ruang Administrasi" title="contoh: ruang kepala sekolah dan ruang tata usaha">Bangunan/Ruang Administrasi</option>
                            <option value="Bangunan/Ruang Penunjang" title="contoh: ruang UKS dan ruang ibadah">Bangunan/Ruang Penunjang</option>
                            <option value="Fasilitas Umum & Utilitas" title="contoh: instalasi listrik dan sistem sanitasi atau drainase">Fasilitas Umum & Utilitas</option>
                            <option value="Area Terbuka (Lahan)" title="contoh: lapangan upacara dan taman sekolah">Area Terbuka (Lahan)</option>
                        </optgroup>
                    </select>
                </div>
                <!-- Input Kondisi diganti menjadi 3 kolom -->
                <div class="form-group">
                    <label for="jumlahBaik">Jumlah Kondisi Baik:</label>
                    <input type="number" id="jumlahBaik" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label for="jumlahRusakRingan">Jumlah Kondisi Rusak Ringan:</label>
                    <input type="number" id="jumlahRusakRingan" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label for="jumlahRusakBerat">Jumlah Kondisi Rusak Berat:</label>
                    <input type="number" id="jumlahRusakBerat" min="0" value="0" required>
                </div>
                
                <div class="btn-container">
                    <button type="submit" class="btn btn-success" id="tombolSubmit">Simpan</button>
                    <button type="button" class="btn btn-danger" id="tombolBatal">Batal</button>
                </div>
            </form>
        </div>

        <!-- Tabel Daftar Inventaris -->
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Barang</th>
                        <th>Kategori</th>
                        <th>Total Jumlah</th>
                        <th>Baik</th>
                        <th>Rusak Ringan</th>
                        <th>Rusak Berat</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelInventaris">
                    <!-- Data akan dimuat di sini dengan JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Tombol Tambah Dipindah ke Bawah -->
        <div class="btn-container">
            <button id="tombolTambah" class="btn btn-primary">+ Tambah Barang Baru</button>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">
                    <span id="modalIconSymbol">✓</span>
                </div>
                <div class="modal-title" id="modalTitle">Notifikasi</div>
            </div>
            <div class="modal-body" id="modalMessage">
                Pesan notifikasi akan muncul di sini.
            </div>
            <div class="modal-footer">
                <button class="modal-button primary" id="modalButton">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- Inisialisasi Supabase ---
        const supabaseUrl = 'https://hjvppgbcltgiibdxqtka.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqdnBwZ2JjbHRnaWliZHhxdGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyNzUzNDgsImV4cCI6MjA0OTg1MTM0OH0.3X7KMHg3qMdsgYsulWxC-hGvpjkGt-9V_YTbd7PSeOw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Mendapatkan elemen-elemen HTML yang diperlukan
        const formContainer = document.getElementById('formContainer');
        const formInventaris = document.getElementById('formInventaris');
        const judulForm = document.getElementById('judulForm');
        const tombolTambah = document.getElementById('tombolTambah');
        const tombolSubmit = document.getElementById('tombolSubmit');
        const tombolBatal = document.getElementById('tombolBatal');
        const tabelInventaris = document.getElementById('tabelInventaris');
        const inputId = document.getElementById('barangId');

        // Variabel global untuk menyimpan data dari Supabase
        let inventaris = [];

        // Event Listeners
        tombolTambah.addEventListener('click', tampilkanFormTambah);
        tombolBatal.addEventListener('click', sembunyikanForm);
        formInventaris.addEventListener('submit', simpanData);

        // Panggil fungsi untuk menampilkan data saat halaman dimuat
        document.addEventListener('DOMContentLoaded', tampilkanData);

        // --- FUNGSI-FUNGSI UTAMA ---

    // --- CUSTOM ALERT FUNCTION ---
    function showAlert(title, message, type = 'success') {
        const modal = document.getElementById('alertModal');
        const modalIcon = document.getElementById('modalIcon');
        const modalIconSymbol = document.getElementById('modalIconSymbol');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalButton = document.getElementById('modalButton');

        // Set the icon and color based on type
        modalIcon.className = 'modal-icon ' + type;
        
        switch(type) {
            case 'success':
                modalIconSymbol.textContent = '✓';
                break;
            case 'error':
                modalIconSymbol.textContent = '✕';
                break;
            default:
                modalIconSymbol.textContent = 'i';
                break;
        }

        // Set the content
        modalTitle.textContent = title;
        modalMessage.textContent = message;

        // Show the modal
        modal.classList.add('show');

        // Add event listener to close button
        modalButton.onclick = () => modal.classList.remove('show');
    }

    async function tampilkanData() {
        tabelInventaris.innerHTML = '';
        
        // Ambil data dari Supabase
        const { data, error } = await supabase
            .from('ra_inventaris')
            .select('*')
            .order('nama_barang', { ascending: true });

        if (error) {
            console.error('Error fetching data:', error);
            tabelInventaris.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Gagal memuat data. Periksa koneksi dan konsol.</td></tr>`;
            return;
        }

        inventaris = data; // Simpan data ke variabel global

        if (inventaris.length === 0) {
            tabelInventaris.innerHTML = `<tr><td colspan="8" style="text-align:center;">Belum ada data inventaris.</td></tr>`;
            return;
        }

        inventaris.forEach((barang, index) => {
            const totalJumlah = (barang.kondisi_baik || 0) + (barang.kondisi_rusak_ringan || 0) + (barang.kondisi_rusak_berat || 0);
            const row = tabelInventaris.insertRow();
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${barang.nama_barang}</td>
                <td>${barang.kategori}</td>
                <td>${totalJumlah}</td>
                <td>${barang.kondisi_baik || 0}</td>
                <td>${barang.kondisi_rusak_ringan || 0}</td>
                <td>${barang.kondisi_rusak_berat || 0}</td>
                <td class="action-buttons">
                    <button class="btn btn-warning" onclick="editBarang(${barang.id})">Edit</button>
                    <button class="btn btn-danger" onclick="hapusBarang(${barang.id})">Hapus</button>
                </td>
            `;
        });
    }

    function tampilkanFormTambah() {
        formContainer.classList.add('active');
        judulForm.innerText = 'Tambah Barang Baru';
        tombolSubmit.innerText = 'Simpan';
        formInventaris.reset();
        document.getElementById('jumlahBaik').value = 0;
        document.getElementById('jumlahRusakRingan').value = 0;
        document.getElementById('jumlahRusakBerat').value = 0;
        
        inputId.value = '';
        formContainer.scrollIntoView({ behavior: 'smooth' });
    }

    function sembunyikanForm() {
        formContainer.classList.remove('active');
    }

    async function simpanData(event) {
        event.preventDefault();

        const id = inputId.value;
        const jmlBaik = parseInt(document.getElementById('jumlahBaik').value) || 0;
        const jmlRusakRingan = parseInt(document.getElementById('jumlahRusakRingan').value) || 0;
        const jmlRusakBerat = parseInt(document.getElementById('jumlahRusakBerat').value) || 0;

        const dataToSave = {
            nama_barang: document.getElementById('namaBarang').value,
            kategori: document.getElementById('kategori').value,
            kondisi_baik: jmlBaik,
            kondisi_rusak_ringan: jmlRusakRingan,
            kondisi_rusak_berat: jmlRusakBerat,
        };

        // Jika ini adalah mode edit, tambahkan ID ke objek
        if (id) {
            dataToSave.id = parseInt(id);
        }

        // Gunakan upsert: insert jika tidak ada ID, update jika ada ID
        const { error } = await supabase
            .from('ra_inventaris')
            .upsert([dataToSave]);

        if (error) {
            console.error('Error saving data:', error);
            showAlert('Gagal', `Gagal menyimpan data: ${error.message}`, 'error');
        } else {
            showAlert('Berhasil', 'Data berhasil disimpan!');
            tampilkanData(); // Muat ulang data dari Supabase
            sembunyikanForm();
        }
    }

    function editBarang(id) {
        // Cari barang di data lokal yang sudah diambil dari Supabase
        const barang = inventaris.find(b => b.id === id);
        if (barang) {
            formContainer.classList.add('active');
            judulForm.innerText = 'Edit Barang';
            tombolSubmit.innerText = 'Perbarui';

            inputId.value = barang.id;
            document.getElementById('namaBarang').value = barang.nama_barang;
            document.getElementById('kategori').value = barang.kategori;
            document.getElementById('jumlahBaik').value = barang.kondisi_baik || 0;
            document.getElementById('jumlahRusakRingan').value = barang.kondisi_rusak_ringan || 0;
            document.getElementById('jumlahRusakBerat').value = barang.kondisi_rusak_berat || 0;
            
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function hapusBarang(id) {
        if (confirm('Apakah Anda yakin ingin menghapus barang ini?')) {
            const { error } = await supabase
                .from('ra_inventaris')
                .delete()
                .eq('id', id);

            if (error) {
                console.error('Error deleting data:', error);
                showAlert('Gagal', `Gagal menghapus data: ${error.message}`, 'error');
            } else {
                showAlert('Berhasil', 'Data berhasil dihapus.');
                tampilkanData(); // Muat ulang data
            }
        }
    }

    </script>
</body>
</html>
