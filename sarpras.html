<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Inventaris RA Tahfidzi</title>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Gaya Umum */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        h1, h2 {
            color: #28a745;
            text-align: center;
        }

        /* Gaya Form */
        .form-container {
            background-color: #d4edda;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* Gaya Tombol */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.2s;
            white-space: nowrap; /* Mencegah teks tombol pecah baris */
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary { background-color: #28a745; color: white; }
        .btn-primary:hover { background-color: #218838; }
        .btn-success { background-color: #20c997; color: white; }
        .btn-success:hover { background-color: #1aa179; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-container {
            text-align: center;
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Gaya Card Statistik */
        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 15px;
        }

        .stat-card {
            flex: 1;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 4px solid;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .stat-card.baik {
            border-top-color: #28a745;
        }

        .stat-card.rusak-ringan {
            border-top-color: #ffc107;
        }

        .stat-card.rusak-berat {
            border-top-color: #dc3545;
        }

        .stat-percentage {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-card.baik .stat-percentage {
            color: #28a745;
        }

        .stat-card.rusak-ringan .stat-percentage {
            color: #ffc107;
        }

        .stat-card.rusak-berat .stat-percentage {
            color: #dc3545;
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-count {
            font-size: 0.9rem;
            color: #888;
        }

        .total-label {
            text-align: center;
            margin-top: 10px;
            font-size: 1.1rem;
            color: #555;
            font-weight: 600;
        }

        /* Gaya Filter dan Pencarian */
        .filter-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-container {
            position: relative;
            flex: 2;
            min-width: 250px;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }

        .autocomplete-item.selected {
            background-color: #e9ecef;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
        }

        /* Gaya Tabel */
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 800px; /* Lebar minimum disesuaikan */
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #28a745;
            color: white;
        }
        
        th:nth-child(5), th:nth-child(6), th:nth-child(7) {
            text-align: center;
        }
        
        td:nth-child(5), td:nth-child(6), td:nth-child(7) {
            text-align: center;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #e9ecef;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center; /* Pastikan tombol selalu di tengah */
        }
        
        /* --- FITUR STICKY COLUMN (HANYA UNTUK NAMA BARANG) --- */
        th:nth-child(1), td:nth-child(1) {
            width: 50px;
            min-width: 50px;
        }

        th:nth-child(2),
        td:nth-child(2) {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #28a745;
            color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            max-width: 250px;
            min-width: 150px;
            /* PERUBAHAN: Memungkinkan teks untuk ter-enter ke bawah */
            overflow-wrap: break-word;
            word-wrap: break-word; /* Untuk kompatibilitas browser lama */
            white-space: normal;
        }
        td:nth-child(2) {
            color: #000;
            background-color: #fff;
        }
        tr:nth-child(even) td:nth-child(2) {
            color: #000;
            background-color: #f2f2f2;
        }

        th:last-child, td:last-child {
            width: 180px;
            min-width: 180px;
            text-align: center;
        }
        
        /* Gaya Paginasi */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pagination-info {
            color: #555;
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #f0f0f0;
            border-color: #aaa;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .page-number {
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-ellipsis {
            padding: 0 5px;
            color: #666;
        }
        
        /* --- MEDIA QUERY UNTUK RESPONSIVITAS --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            h1 { font-size: 24px; }
            h2 { font-size: 20px; }
            .btn { font-size: 14px; padding: 8px 15px; }
            .form-group { margin-bottom: 10px; }
            th, td { padding: 8px 5px; font-size: 14px; }
            .action-buttons .btn { padding: 5px 8px; font-size: 12px; }
            
            /* Adjustments for stat cards on mobile */
            .stat-card {
                padding: 15px 10px;
            }
            .stat-percentage {
                font-size: 1.8rem;
            }
            .stat-label {
                font-size: 0.9rem;
            }

            /* Filter adjustments for mobile */
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group, .search-container {
                width: 100%;
                min-width: auto;
            }

            /* Pagination adjustments for mobile */
            .pagination-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Custom Alert Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            transform: scale(0.8);
            transition: transform 0.3s;
            overflow: hidden;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
            flex-shrink: 0;
        }

        .modal-icon.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .modal-icon.error {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-body {
            padding: 20px;
            color: #333;
            line-height: 1.5;
        }

        .modal-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #eee;
        }

        .modal-button {
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-button.primary {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login Section (Optional, for future use) -->
        <div id="loginSection" style="display: none;">
            <h2>Login</h2>
            <!-- Login form can be added here -->
        </div>

        <h1>Aplikasi Inventaris Sarana dan Prasarana</h1>
        <h2>RA Tahfidzi</h2>

        <!-- Card Statistik -->
        <div class="stats-container">
            <div class="stat-card baik">
                <div class="stat-label">Kondisi Baik</div>
                <div class="stat-percentage" id="persentaseBaik">0%</div>
                <div class="stat-count" id="jumlahBaik">0 item</div>
            </div>
            <div class="stat-card rusak-ringan">
                <div class="stat-label">Rusak Ringan</div>
                <div class="stat-percentage" id="persentaseRusakRingan">0%</div>
                <div class="stat-count" id="jumlahRusakRingan">0 item</div>
            </div>
            <div class="stat-card rusak-berat">
                <div class="stat-label">Rusak Berat</div>
                <div class="stat-percentage" id="persentaseRusakBerat">0%</div>
                <div class="stat-count" id="jumlahRusakBerat">0 item</div>
            </div>
        </div>
        <div class="total-label">Total Sarpras: <span id="totalSemua">0</span> item</div>

        <!-- Filter dan Pencarian -->
        <div class="filter-container">
            <div class="search-container">
                <label for="searchInput">Cari Nama Barang:</label>
                <input type="text" id="searchInput" placeholder="Ketik untuk mencari...">
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
            <div class="filter-group">
                <label for="filterKategori">Filter Kategori:</label>
                <select id="filterKategori">
                    <option value="">Semua Kategori</option>
                    <optgroup label="I. SARANA">
                        <option value="Perabot (Mebelair)">Perabot (Mebelair)</option>
                        <option value="Peralatan Pendidikan (Non-Elektronik)">Peralatan Pendidikan (Non-Elektronik)</option>
                        <option value="Buku dan Sumber Belajar">Buku dan Sumber Belajar</option>
                        <option value="Sarana Olahraga">Sarana Olahraga</option>
                        <option value="Sarana Kesenian">Sarana Kesenian</option>
                        <option value="Sarana Keselamatan">Sarana Keselamatan</option>
                        <option value="Peralatan Elektronik">Peralatan Elektronik</option>
                        <option value="Permainan Pendidikan">Permainan Pendidikan</option>
                        <option value="Alat Peraga Edukatif (APE)">Alat Peraga Edukatif (APE)</option>
                    </optgroup>
                    <optgroup label="II. PRASARANA (Bangunan dan Lahan)">
                        <option value="Bangunan/Ruang Administrasi">Bangunan/Ruang Administrasi</option>
                        <option value="Bangunan/Ruang Penunjang">Bangunan/Ruang Penunjang</option>
                        <option value="Fasilitas Umum & Utilitas">Fasilitas Umum & Utilitas</option>
                        <option value="Area Terbuka (Lahan)">Area Terbuka (Lahan)</option>
                    </optgroup>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterKondisi">Filter Kondisi:</label>
                <select id="filterKondisi">
                    <option value="">Semua Kondisi</option>
                    <option value="baik">Ada yang Baik</option>
                    <option value="rusak-ringan">Ada yang Rusak Ringan</option>
                    <option value="rusak-berat">Ada yang Rusak Berat</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" id="applyFilters">Terapkan Filter</button>
                <button class="btn btn-secondary" id="resetFilters">Reset</button>
            </div>
        </div>

        <!-- Form untuk Tambah/Edit Barang -->
        <div id="formContainer" class="form-container">
            <h2 id="judulForm">Tambah Barang Baru</h2>
            <form id="formInventaris">
                <input type="hidden" id="barangId">
                <div class="form-group">
                    <label for="namaBarang">Nama Barang:</label>
                    <input type="text" id="namaBarang" required>
                </div>
                <div class="form-group">
                    <label for="kategori">Kategori:</label>
                    <select id="kategori" required>
                        <option value="">-- Pilih Kategori --</option>
                        <optgroup label="I. SARANA">
                            <option value="Perabot (Mebelair)" title="contoh: kursi dan meja siswa serta lemari arsip">Perabot (Mebelair)</option>
                            <option value="Peralatan Pendidikan (Non-Elektronik)" title="contoh: papan tulis konvensional dan globe">Peralatan Pendidikan (Non-Elektronik)</option>
                            <option value="Buku dan Sumber Belajar" title="contoh: buku teks pelajaran dan buku bacaan fiksi untuk perpustakaan">Buku dan Sumber Belajar</option>
                            <option value="Sarana Olahraga" title="contoh: bola basket atau sepak bola serta net voli atau tenis">Sarana Olahraga</option>
                            <option value="Sarana Kesenian" title="contoh: gitar atau keyboard serta peralatan melukis atau pahat">Sarana Kesenian</option>
                            <option value="Sarana Keselamatan" title="contoh: kotak P3K dan APAR">Sarana Keselamatan</option>
                            <option value="Peralatan Elektronik" title="contoh: laptop atau komputer serta proyektor LCD">Peralatan Elektronik</option>
                            <option value="Permainan Pendidikan" title="contoh: puzzle dan balok susun">Permainan Pendidikan</option>
                            <option value="Alat Peraga Edukatif (APE)" title="contoh: kartu huruf/angka dan papan geometri">Alat Peraga Edukatif (APE)</option>
                        </optgroup>
                        <optgroup label="II. PRASARANA (Bangunan dan Lahan)">
                            <option value="Bangunan/Ruang Administrasi" title="contoh: ruang kepala sekolah dan ruang tata usaha">Bangunan/Ruang Administrasi</option>
                            <option value="Bangunan/Ruang Penunjang" title="contoh: ruang UKS dan ruang ibadah">Bangunan/Ruang Penunjang</option>
                            <option value="Fasilitas Umum & Utilitas" title="contoh: instalasi listrik dan sistem sanitasi atau drainase">Fasilitas Umum & Utilitas</option>
                            <option value="Area Terbuka (Lahan)" title="contoh: lapangan upacara dan taman sekolah">Area Terbuka (Lahan)</option>
                        </optgroup>
                    </select>
                </div>
                <!-- Input Kondisi diganti menjadi 3 kolom -->
                <div class="form-group">
                    <label for="jumlahBaik" class="block text-sm font-medium text-gray-700">Jumlah Baik</label>
                    <input type="number" id="inputJumlahBaik" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label for="jumlahRusakRingan" class="block text-sm font-medium text-gray-700">Jumlah Rusak Ringan</label>
                    <input type="number" id="inputJumlahRusakRingan" min="0" value="0" required>
                </div>
                <div class="form-group">
                    <label for="jumlahRusakBerat" class="block text-sm font-medium text-gray-700">Jumlah Rusak Berat</label>
                    <input type="number" id="inputJumlahRusakBerat" min="0" value="0" required>
                </div>
                
                <div class="btn-container">
                    <button type="submit" class="btn btn-success" id="tombolSubmit">Simpan</button>
                    <button type="button" class="btn btn-danger" id="tombolBatal">Batal</button>
                </div>
            </form>
        </div>

        <!-- Tabel Daftar Inventaris -->
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Barang</th>
                        <th>Kategori</th>
                        <th>Total Jumlah</th>
                        <th>Baik</th>
                        <th>Rusak Ringan</th>
                        <th>Rusak Berat</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelInventaris">
                    <!-- Data akan dimuat di sini dengan JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Paginasi -->
        <div class="pagination-container">
            <div class="pagination-info">
                Menampilkan <span id="startRecord">0</span>-<span id="endRecord">0</span> dari <span id="totalRecords">0</span> data
            </div>
            <div class="pagination-controls" id="paginationControls">
                <!-- Tombol paginasi akan dibuat dengan JavaScript -->
            </div>
        </div>

        <!-- Tombol Tambah dan Export -->
        <div class="btn-container">
            <button id="tombolTambah" class="btn btn-primary">+ Tambah Barang Baru</button>
            <button id="tombolExport" class="btn btn-success">ðŸ“Š Export ke Excel</button>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">
                    <span id="modalIconSymbol">âœ“</span>
                </div>
                <div class="modal-title" id="modalTitle">Notifikasi</div>
            </div>
            <div class="modal-body" id="modalMessage">
                Pesan notifikasi akan muncul di sini.
            </div>
            <div class="modal-footer">
                <button class="modal-button primary" id="modalButton">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- Inisialisasi Supabase ---
        const supabaseUrl = 'https://hjvppgbcltgiibdxqtka.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqdnBwZ2JjbHRnaWliZHhxdGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyNzUzNDgsImV4cCI6MjA0OTg1MTM0OH0.3X7KMHg3qMdsgYsulWxC-hGvpjkGt-9V_YTbd7PSeOw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Mendapatkan elemen-elemen HTML yang diperlukan
        const formContainer = document.getElementById('formContainer');
        const formInventaris = document.getElementById('formInventaris');
        const judulForm = document.getElementById('judulForm');
        const tombolTambah = document.getElementById('tombolTambah');
        const tombolExport = document.getElementById('tombolExport');
        const tombolSubmit = document.getElementById('tombolSubmit');
        const tombolBatal = document.getElementById('tombolBatal');
        const tabelInventaris = document.getElementById('tabelInventaris');
        const inputId = document.getElementById('barangId');
        const paginationControls = document.getElementById('paginationControls');
        
        // Filter dan pencarian
        const searchInput = document.getElementById('searchInput');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        const filterKategori = document.getElementById('filterKategori');
        const filterKondisi = document.getElementById('filterKondisi');
        const applyFilters = document.getElementById('applyFilters');
        const resetFilters = document.getElementById('resetFilters');

        // Variabel global untuk menyimpan data dari Supabase
        let inventaris = [];
        let filteredInventaris = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let totalPages = 0;
        let selectedAutocompleteIndex = -1;

        // Event Listeners
        tombolTambah.addEventListener('click', tampilkanFormTambah);
        tombolExport.addEventListener('click', exportToExcel);
        tombolBatal.addEventListener('click', sembunyikanForm);
        formInventaris.addEventListener('submit', simpanData);
        applyFilters.addEventListener('click', terapkanFilter);
        resetFilters.addEventListener('click', resetFilter);
        
        // Autocomplete event listeners
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('focus', handleSearchInput);
        searchInput.addEventListener('keydown', handleAutocompleteKeydown);
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                autocompleteDropdown.style.display = 'none';
            }
        });

        // Panggil fungsi untuk menampilkan data saat halaman dimuat
        document.addEventListener('DOMContentLoaded', tampilkanData);

        // --- FUNGSI-FUNGSI UTAMA ---

    // --- CUSTOM ALERT FUNCTION ---
    function showAlert(title, message, type = 'success') {
        const modal = document.getElementById('alertModal');
        const modalIcon = document.getElementById('modalIcon');
        const modalIconSymbol = document.getElementById('modalIconSymbol');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalButton = document.getElementById('modalButton');

        // Set the icon and color based on type
        modalIcon.className = 'modal-icon ' + type;
        
        switch(type) {
            case 'success':
                modalIconSymbol.textContent = 'âœ“';
                break;
            case 'error':
                modalIconSymbol.textContent = 'âœ•';
                break;
            default:
                modalIconSymbol.textContent = 'i';
                break;
        }

        // Set the content
        modalTitle.textContent = title;
        modalMessage.textContent = message;

        // Show the modal
        modal.classList.add('show');

        // Add event listener to close button
        modalButton.onclick = () => modal.classList.remove('show');
    }

    async function tampilkanData() {
        tabelInventaris.innerHTML = '';
        
        // Ambil data dari Supabase
        const { data, error } = await supabase
            .from('ra_inventaris')
            .select('*')
            .order('nama_barang', { ascending: true });

        if (error) {
            console.error('Error fetching data:', error);
            tabelInventaris.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Gagal memuat data. Periksa koneksi dan konsol.</td></tr>`;
            return;
        }

        inventaris = data; // Simpan data ke variabel global
        filteredInventaris = [...inventaris]; // Inisialisasi filtered data
        
        // Terapkan filter yang aktif
        terapkanFilter();
    }

    function handleSearchInput() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        if (searchTerm === '') {
            autocompleteDropdown.style.display = 'none';
            return;
        }
        
        // Filter barang yang cocok dengan pencarian
        const matches = inventaris.filter(barang => 
            barang.nama_barang.toLowerCase().includes(searchTerm)
        );
        
        // Tampilkan autocomplete dropdown
        if (matches.length > 0) {
            autocompleteDropdown.innerHTML = '';
            matches.slice(0, 5).forEach((barang, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = barang.nama_barang;
                item.onclick = () => selectAutocompleteItem(barang.nama_barang);
                autocompleteDropdown.appendChild(item);
            });
            autocompleteDropdown.style.display = 'block';
            selectedAutocompleteIndex = -1;
        } else {
            autocompleteDropdown.innerHTML = '<div class="autocomplete-item">Tidak ada hasil</div>';
            autocompleteDropdown.style.display = 'block';
        }
    }

    function handleAutocompleteKeydown(e) {
        const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
            updateAutocompleteSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, 0);
            updateAutocompleteSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedAutocompleteIndex >= 0 && items[selectedAutocompleteIndex]) {
                items[selectedAutocompleteIndex].click();
            }
        } else if (e.key === 'Escape') {
            autocompleteDropdown.style.display = 'none';
        }
    }

    function updateAutocompleteSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedAutocompleteIndex) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    function selectAutocompleteItem(namaBarang) {
        searchInput.value = namaBarang;
        autocompleteDropdown.style.display = 'none';
        terapkanFilter();
    }

    function terapkanFilter() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const kategoriFilter = filterKategori.value;
        const kondisiFilter = filterKondisi.value;
        
        // Filter berdasarkan semua kriteria
        filteredInventaris = inventaris.filter(barang => {
            // Filter nama barang
            const matchSearch = searchTerm === '' || 
                barang.nama_barang.toLowerCase().includes(searchTerm);
            
            // Filter kategori
            const matchKategori = kategoriFilter === '' || 
                barang.kategori === kategoriFilter;
            
            // Filter kondisi
            let matchKondisi = true;
            if (kondisiFilter === 'baik') {
                matchKondisi = (barang.kondisi_baik || 0) > 0;
            } else if (kondisiFilter === 'rusak-ringan') {
                matchKondisi = (barang.kondisi_rusak_ringan || 0) > 0;
            } else if (kondisiFilter === 'rusak-berat') {
                matchKondisi = (barang.kondisi_rusak_berat || 0) > 0;
            }
            
            return matchSearch && matchKategori && matchKondisi;
        });
        
        // Reset ke halaman pertama
        currentPage = 1;
        
        // Tampilkan data yang sudah difilter
        tampilkanDataHalaman(currentPage);
    }

    function resetFilter() {
        searchInput.value = '';
        filterKategori.value = '';
        filterKondisi.value = '';
        autocompleteDropdown.style.display = 'none';
        
        // Reset filtered data
        filteredInventaris = [...inventaris];
        currentPage = 1;
        
        // Tampilkan semua data
        tampilkanDataHalaman(currentPage);
    }

    function tampilkanDataHalaman(page) {
        tabelInventaris.innerHTML = '';
        
        if (filteredInventaris.length === 0) {
            tabelInventaris.innerHTML = `<tr><td colspan="8" style="text-align:center;">Tidak ada data yang sesuai dengan filter.</td></tr>`;
            updatePaginationInfo(0, 0, 0);
            paginationControls.innerHTML = '';
            updateStatistik(0, 0, 0);
            return;
        }
        
        // Hitung indeks awal dan akhir
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredInventaris.length);
        
        // Ambil data untuk halaman ini
        const pageData = filteredInventaris.slice(startIndex, endIndex);
        
        // Update info paginasi
        updatePaginationInfo(startIndex + 1, endIndex, filteredInventaris.length);
        
        // PERBAIKAN: Hitung statistik dari keseluruhan data, bukan hanya yang difilter
        let totalBaik = 0;
        let totalRusakRingan = 0;
        let totalRusakBerat = 0;
        
        inventaris.forEach((barang) => { // Menggunakan variabel 'inventaris' (data asli)
            totalBaik += barang.kondisi_baik || 0;
            totalRusakRingan += barang.kondisi_rusak_ringan || 0;
            totalRusakBerat += barang.kondisi_rusak_berat || 0;
        });
        
        // Update kartu statistik dengan data keseluruhan
        updateStatistik(totalBaik, totalRusakRingan, totalRusakBerat);
        
        // Tampilkan data yang sudah difilter ke dalam tabel
        pageData.forEach((barang, index) => {
            const baik = barang.kondisi_baik || 0;
            const rusakRingan = barang.kondisi_rusak_ringan || 0;
            const rusakBerat = barang.kondisi_rusak_berat || 0;
            const totalJumlah = baik + rusakRingan + rusakBerat;
            
            const row = tabelInventaris.insertRow();
            row.innerHTML = `
                <td>${startIndex + index + 1}</td>
                <td>${barang.nama_barang}</td>
                <td>${barang.kategori}</td>
                <td>${totalJumlah}</td>
                <td>${baik}</td>
                <td>${rusakRingan}</td>
                <td>${rusakBerat}</td>
                <td class="action-buttons">
                    <button class="btn btn-warning" onclick="editBarang(${barang.id})">Edit</button>
                    <button class="btn btn-danger" onclick="hapusBarang(${barang.id})">Hapus</button>
                </td>
            `;
        });
        
        // Hitung total halaman
        totalPages = Math.ceil(filteredInventaris.length / itemsPerPage);
        
        // Update kontrol paginasi
        updatePaginationControls();
    }

    function updatePaginationInfo(start, end, total) {
        document.getElementById('startRecord').textContent = start;
        document.getElementById('endRecord').textContent = end;
        document.getElementById('totalRecords').textContent = total;
    }

    function updatePaginationControls() {
        paginationControls.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Tombol Previous
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.innerHTML = '&laquo; Prev';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                tampilkanDataHalaman(currentPage);
                updatePaginationControls();
            }
        };
        paginationControls.appendChild(prevBtn);
        
        // Tombol nomor halaman
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        // Ellipsis awal jika perlu
        if (startPage > 1) {
            const firstBtn = createPageButton(1);
            paginationControls.appendChild(firstBtn);
            
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                paginationControls.appendChild(ellipsis);
            }
        }
        
        // Nomor halaman
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = createPageButton(i);
            paginationControls.appendChild(pageBtn);
        }
        
        // Ellipsis akhir jika perlu
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'pagination-ellipsis';
                ellipsis.textContent = '...';
                paginationControls.appendChild(ellipsis);
            }
            
            const lastBtn = createPageButton(totalPages);
            paginationControls.appendChild(lastBtn);
        }
        
        // Tombol Next
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.innerHTML = 'Next &raquo;';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                tampilkanDataHalaman(currentPage);
                updatePaginationControls();
            }
        };
        paginationControls.appendChild(nextBtn);
    }

    function createPageButton(pageNum) {
        const btn = document.createElement('button');
        btn.className = 'pagination-btn page-number';
        if (pageNum === currentPage) {
            btn.classList.add('active');
        }
        btn.textContent = pageNum;
        btn.onclick = () => {
            currentPage = pageNum;
            tampilkanDataHalaman(currentPage);
            updatePaginationControls();
        };
        return btn;
    }

    function updateStatistik(baik, rusakRingan, rusakBerat) {
        const total = baik + rusakRingan + rusakBerat;
        
        // Hitung persentase
        const persentaseBaik = total > 0 ? Math.round((baik / total) * 100) : 0;
        const persentaseRusakRingan = total > 0 ? Math.round((rusakRingan / total) * 100) : 0;
        const persentaseRusakBerat = total > 0 ? Math.round((rusakBerat / total) * 100) : 0;
        
        // Update elemen HTML
        document.getElementById('persentaseBaik').textContent = `${persentaseBaik}%`;
        document.getElementById('persentaseRusakRingan').textContent = `${persentaseRusakRingan}%`;
        document.getElementById('persentaseRusakBerat').textContent = `${persentaseRusakBerat}%`;
        
        document.getElementById('jumlahBaik').textContent = `${baik} item`;
        document.getElementById('jumlahRusakRingan').textContent = `${rusakRingan} item`;
        document.getElementById('jumlahRusakBerat').textContent = `${rusakBerat} item`;
        
        document.getElementById('totalSemua').textContent = total;
    }

    function tampilkanFormTambah() {
        formContainer.classList.add('active');
        judulForm.innerText = 'Tambah Barang Baru';
        tombolSubmit.innerText = 'Simpan';
        formInventaris.reset();
        document.getElementById('inputJumlahBaik').value = 0;
        document.getElementById('inputJumlahRusakRingan').value = 0;
        document.getElementById('inputJumlahRusakBerat').value = 0;
        
        inputId.value = '';
        formContainer.scrollIntoView({ behavior: 'smooth' });
    }

    function sembunyikanForm() {
        formContainer.classList.remove('active');
    }

    async function simpanData(event) {
        event.preventDefault();

        const id = inputId.value;
        // Perbaikan: Gunakan Number() untuk konversi yang lebih aman dan fallback ke 0 jika kosong.
        // Ini memastikan string kosong ("") menjadi 0, dan string angka ("5") menjadi 5.
        const jmlBaik = Number(document.getElementById('inputJumlahBaik').value) || 0;
        const jmlRusakRingan = Number(document.getElementById('inputJumlahRusakRingan').value) || 0;
        const jmlRusakBerat = Number(document.getElementById('inputJumlahRusakBerat').value) || 0;


        const dataToSave = {
            nama_barang: document.getElementById('namaBarang').value,
            kategori: document.getElementById('kategori').value,
            kondisi_baik: jmlBaik,
            kondisi_rusak_ringan: jmlRusakRingan,
            kondisi_rusak_berat: jmlRusakBerat,
        };

        let error;
        let updatedData = null; // Tambahkan variabel untuk menyimpan data yang diperbarui

        if (id) {
            // Mode Edit: update data yang ada. Kirim objek langsung, bukan array.
            const { data, error: updateError } = await supabase
                .from('ra_inventaris')
                .update(dataToSave)
                .eq('id', id)
                .select(); // Tambahkan .select() untuk memastikan data dikembalikan
            error = updateError;
            updatedData = data; // Simpan data yang diperbarui
            console.log('Data setelah update dari Supabase:', updatedData); // Log data setelah update

            // Periksa apakah ada data yang berhasil diperbarui
            if (!error && (!updatedData || updatedData.length === 0)) {
                error = { message: 'Tidak ada data yang diperbarui. Pastikan ID barang benar dan ada perubahan data.' };
            }

        } else {
            // Mode Tambah: insert data baru (tanpa menyertakan ID)
            const { error: insertError } = await supabase.from('ra_inventaris').insert([dataToSave]);
            error = insertError;
        }

        if (error) {
            console.error('Error saving data:', error);
            showAlert('Gagal', `Gagal menyimpan data: ${error.message}`, 'error');
        } else {
            showAlert('Berhasil', 'Data berhasil disimpan!');
            currentPage = 1; // Kembali ke halaman pertama setelah menambah data
            tampilkanData(); // Muat ulang data dari Supabase
            sembunyikanForm();
        }
    }

    function editBarang(id) {
        // Cari barang di data lokal yang sudah diambil dari Supabase
        const barang = inventaris.find(b => b.id === id);
        if (barang) {
            formContainer.classList.add('active');
            judulForm.innerText = 'Edit Barang';
            tombolSubmit.innerText = 'Perbarui';

            inputId.value = barang.id;
            document.getElementById('namaBarang').value = barang.nama_barang;
            document.getElementById('kategori').value = barang.kategori;
            document.getElementById('inputJumlahBaik').value = barang.kondisi_baik || 0;
            document.getElementById('inputJumlahRusakRingan').value = barang.kondisi_rusak_ringan || 0;
            document.getElementById('inputJumlahRusakBerat').value = barang.kondisi_rusak_berat || 0;
            
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function hapusBarang(id) {
        if (confirm('Apakah Anda yakin ingin menghapus barang ini?')) {
            const { error } = await supabase
                .from('ra_inventaris')
                .delete()
                .eq('id', id);

            if (error) {
                console.error('Error deleting data:', error);
                showAlert('Gagal', `Gagal menghapus data: ${error.message}`, 'error');
            } else {
                showAlert('Berhasil', 'Data berhasil dihapus.');
                
                // Jika data di halaman saat ini habis, kembali ke halaman sebelumnya
                const itemsOnCurrentPage = filteredInventaris.length - ((currentPage - 1) * itemsPerPage);
                if (itemsOnCurrentPage === 1 && currentPage > 1) {
                    currentPage--;
                }
                
                tampilkanData(); // Muat ulang data
            }
        }
    }

    // --- FUNGSI EXPORT TO EXCEL ---
    function exportToExcel() {
        // Check if there's data to export
        if (filteredInventaris.length === 0) {
            showAlert('Info', 'Tidak ada data untuk diekspor.', 'error');
            return;
        }

        // Show a processing message
        showAlert('Memproses', 'Sedang menyiapkan file Excel...', 'success');

        // Prepare data for SheetJS (array of arrays)
        const header = ['No', 'Nama Barang', 'Kategori', 'Total Jumlah', 'Baik', 'Rusak Ringan', 'Rusak Berat'];
        const dataRows = filteredInventaris.map((barang, index) => {
            const baik = barang.kondisi_baik || 0;
            const rusakRingan = barang.kondisi_rusak_ringan || 0;
            const rusakBerat = barang.kondisi_rusak_berat || 0;

            return [
                index + 1,
                barang.nama_barang,
                barang.kategori,
                totalJumlah,
                baik,
                rusakRingan,
                rusakBerat
            ];
        });

        const excelData = [header, ...dataRows];

        // Create a new workbook and worksheet
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data Inventaris");

        // Generate filename with current date
        const today = new Date();
        const dateString = today.toISOString().split('T')[0]; // YYYY-MM-DD format
        const fileName = `Inventaris_RA_Tahfidzi_${dateString}.xlsx`;

        // Trigger the download
        XLSX.writeFile(wb, fileName);

        // Show success message
        setTimeout(() => { // Timeout to ensure the file download starts before the alert
            showAlert('Berhasil', `File "${fileName}" berhasil diunduh!`);
        }, 500);
    }

    </script>
</body>
</html>
